function e(){return _||(_=1,Object.defineProperty(b,"__esModule",{value:!0}),b.default=class extends Error{constructor(e){super(e.message),this.name="PostgrestError",this.details=e.details,this.hint=e.hint,this.code=e.code}}),b}function t(){if(w)return v;w=1;var t=v&&v.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(v,"__esModule",{value:!0});const s=t(ge),r=t(e());return v.default=class{constructor(e){this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=e.headers,this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=e.shouldThrowOnError,this.signal=e.signal,this.isMaybeSingle=e.isMaybeSingle,e.fetch?this.fetch=e.fetch:"undefined"==typeof fetch?this.fetch=s.default:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(e,t){return this.headers=Object.assign({},this.headers),this.headers[e]=t,this}then(e,t){void 0===this.schema||(["GET","HEAD"].includes(this.method)?this.headers["Accept-Profile"]=this.schema:this.headers["Content-Profile"]=this.schema),"GET"!==this.method&&"HEAD"!==this.method&&(this.headers["Content-Type"]="application/json");let s=(0,this.fetch)(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async e=>{var t,s,n;let i=null,o=null,a=null,h=e.status,c=e.statusText;if(e.ok){if("HEAD"!==this.method){const t=await e.text();""===t||(o="text/csv"===this.headers.Accept||this.headers.Accept&&this.headers.Accept.includes("application/vnd.pgrst.plan+text")?t:JSON.parse(t))}const r=null===(t=this.headers.Prefer)||void 0===t?void 0:t.match(/count=(exact|planned|estimated)/),n=null===(s=e.headers.get("content-range"))||void 0===s?void 0:s.split("/");r&&n&&n.length>1&&(a=parseInt(n[1])),this.isMaybeSingle&&"GET"===this.method&&Array.isArray(o)&&(o.length>1?(i={code:"PGRST116",details:`Results contain ${o.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},o=null,a=null,h=406,c="Not Acceptable"):o=1===o.length?o[0]:null)}else{const t=await e.text();try{i=JSON.parse(t),Array.isArray(i)&&404===e.status&&(o=[],i=null,h=200,c="OK")}catch(l){404===e.status&&""===t?(h=204,c="No Content"):i={message:t}}if(i&&this.isMaybeSingle&&(null===(n=null==i?void 0:i.details)||void 0===n?void 0:n.includes("0 rows"))&&(i=null,h=200,c="OK"),i&&this.shouldThrowOnError)throw new r.default(i)}return{error:i,data:o,count:a,status:h,statusText:c}});return this.shouldThrowOnError||(s=s.catch(e=>{var t,s,r;return{error:{message:`${null!==(t=null==e?void 0:e.name)&&void 0!==t?t:"FetchError"}: ${null==e?void 0:e.message}`,details:""+(null!==(s=null==e?void 0:e.stack)&&void 0!==s?s:""),hint:"",code:""+(null!==(r=null==e?void 0:e.code)&&void 0!==r?r:"")},data:null,count:null,status:0,statusText:""}})),s.then(e,t)}returns(){return this}overrideTypes(){return this}},v}function s(){if(j)return g;j=1;var e=g&&g.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(g,"__esModule",{value:!0});const s=e(t());class r extends s.default{select(e){let t=!1;const s=(null!=e?e:"*").split("").map(e=>/\s/.test(e)&&!t?"":('"'===e&&(t=!t),e)).join("");return this.url.searchParams.set("select",s),this.headers.Prefer&&(this.headers.Prefer+=","),this.headers.Prefer+="return=representation",this}order(e,{ascending:t=!0,nullsFirst:s,foreignTable:r,referencedTable:n=r}={}){const i=n?n+".order":"order",o=this.url.searchParams.get(i);return this.url.searchParams.set(i,`${o?o+",":""}${e}.${t?"asc":"desc"}${void 0===s?"":s?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:t,referencedTable:s=t}={}){const r=void 0===s?"limit":s+".limit";return this.url.searchParams.set(r,""+e),this}range(e,t,{foreignTable:s,referencedTable:r=s}={}){const n=void 0===r?"offset":r+".offset",i=void 0===r?"limit":r+".limit";return this.url.searchParams.set(n,""+e),this.url.searchParams.set(i,""+(t-e+1)),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.Accept="application/vnd.pgrst.object+json",this}maybeSingle(){return"GET"===this.method?this.headers.Accept="application/json":this.headers.Accept="application/vnd.pgrst.object+json",this.isMaybeSingle=!0,this}csv(){return this.headers.Accept="text/csv",this}geojson(){return this.headers.Accept="application/geo+json",this}explain({analyze:e=!1,verbose:t=!1,settings:s=!1,buffers:r=!1,wal:n=!1,format:i="text"}={}){var o;const a=[e?"analyze":null,t?"verbose":null,s?"settings":null,r?"buffers":null,n?"wal":null].filter(Boolean).join("|"),h=null!==(o=this.headers.Accept)&&void 0!==o?o:"application/json";return this.headers.Accept=`application/vnd.pgrst.plan+${i}; for="${h}"; options=${a};`,this}rollback(){var e;return(null!==(e=this.headers.Prefer)&&void 0!==e?e:"").trim().length>0?this.headers.Prefer+=",tx=rollback":this.headers.Prefer="tx=rollback",this}returns(){return this}}return g.default=r,g}function r(){if(P)return m;P=1;var e=m&&m.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(m,"__esModule",{value:!0});const t=e(s());class r extends t.default{eq(e,t){return this.url.searchParams.append(e,"eq."+t),this}neq(e,t){return this.url.searchParams.append(e,"neq."+t),this}gt(e,t){return this.url.searchParams.append(e,"gt."+t),this}gte(e,t){return this.url.searchParams.append(e,"gte."+t),this}lt(e,t){return this.url.searchParams.append(e,"lt."+t),this}lte(e,t){return this.url.searchParams.append(e,"lte."+t),this}like(e,t){return this.url.searchParams.append(e,"like."+t),this}likeAllOf(e,t){return this.url.searchParams.append(e,`like(all).{${t.join(",")}}`),this}likeAnyOf(e,t){return this.url.searchParams.append(e,`like(any).{${t.join(",")}}`),this}ilike(e,t){return this.url.searchParams.append(e,"ilike."+t),this}ilikeAllOf(e,t){return this.url.searchParams.append(e,`ilike(all).{${t.join(",")}}`),this}ilikeAnyOf(e,t){return this.url.searchParams.append(e,`ilike(any).{${t.join(",")}}`),this}is(e,t){return this.url.searchParams.append(e,"is."+t),this}in(e,t){const s=Array.from(new Set(t)).map(e=>"string"==typeof e&&RegExp("[,()]").test(e)?`"${e}"`:""+e).join(",");return this.url.searchParams.append(e,`in.(${s})`),this}contains(e,t){return"string"==typeof t?this.url.searchParams.append(e,"cs."+t):Array.isArray(t)?this.url.searchParams.append(e,`cs.{${t.join(",")}}`):this.url.searchParams.append(e,"cs."+JSON.stringify(t)),this}containedBy(e,t){return"string"==typeof t?this.url.searchParams.append(e,"cd."+t):Array.isArray(t)?this.url.searchParams.append(e,`cd.{${t.join(",")}}`):this.url.searchParams.append(e,"cd."+JSON.stringify(t)),this}rangeGt(e,t){return this.url.searchParams.append(e,"sr."+t),this}rangeGte(e,t){return this.url.searchParams.append(e,"nxl."+t),this}rangeLt(e,t){return this.url.searchParams.append(e,"sl."+t),this}rangeLte(e,t){return this.url.searchParams.append(e,"nxr."+t),this}rangeAdjacent(e,t){return this.url.searchParams.append(e,"adj."+t),this}overlaps(e,t){return"string"==typeof t?this.url.searchParams.append(e,"ov."+t):this.url.searchParams.append(e,`ov.{${t.join(",")}}`),this}textSearch(e,t,{config:s,type:r}={}){let n="";"plain"===r?n="pl":"phrase"===r?n="ph":"websearch"===r&&(n="w");const i=void 0===s?"":`(${s})`;return this.url.searchParams.append(e,`${n}fts${i}.${t}`),this}match(e){return Object.entries(e).forEach(([e,t])=>{this.url.searchParams.append(e,"eq."+t)}),this}not(e,t,s){return this.url.searchParams.append(e,`not.${t}.${s}`),this}or(e,{foreignTable:t,referencedTable:s=t}={}){const r=s?s+".or":"or";return this.url.searchParams.append(r,`(${e})`),this}filter(e,t,s){return this.url.searchParams.append(e,`${t}.${s}`),this}}return m.default=r,m}function n(){if(k)return p;k=1;var e=p&&p.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(p,"__esModule",{value:!0});const t=e(r());return p.default=class{constructor(e,{headers:t={},schema:s,fetch:r}){this.url=e,this.headers=t,this.schema=s,this.fetch=r}select(e,{head:s=!1,count:r}={}){const n=s?"HEAD":"GET";let i=!1;const o=(null!=e?e:"*").split("").map(e=>/\s/.test(e)&&!i?"":('"'===e&&(i=!i),e)).join("");return this.url.searchParams.set("select",o),r&&(this.headers.Prefer="count="+r),new t.default({method:n,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}insert(e,{count:s,defaultToNull:r=!0}={}){const n=[];if(this.headers.Prefer&&n.push(this.headers.Prefer),s&&n.push("count="+s),r||n.push("missing=default"),this.headers.Prefer=n.join(","),Array.isArray(e)){const t=e.reduce((e,t)=>e.concat(Object.keys(t)),[]);if(t.length>0){const e=[...new Set(t)].map(e=>`"${e}"`);this.url.searchParams.set("columns",e.join(","))}}return new t.default({method:"POST",url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}upsert(e,{onConflict:s,ignoreDuplicates:r=!1,count:n,defaultToNull:i=!0}={}){const o=[`resolution=${r?"ignore":"merge"}-duplicates`];if(void 0!==s&&this.url.searchParams.set("on_conflict",s),this.headers.Prefer&&o.push(this.headers.Prefer),n&&o.push("count="+n),i||o.push("missing=default"),this.headers.Prefer=o.join(","),Array.isArray(e)){const t=e.reduce((e,t)=>e.concat(Object.keys(t)),[]);if(t.length>0){const e=[...new Set(t)].map(e=>`"${e}"`);this.url.searchParams.set("columns",e.join(","))}}return new t.default({method:"POST",url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}update(e,{count:s}={}){const r=[];return this.headers.Prefer&&r.push(this.headers.Prefer),s&&r.push("count="+s),this.headers.Prefer=r.join(","),new t.default({method:"PATCH",url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}delete({count:e}={}){const s=[];return e&&s.push("count="+e),this.headers.Prefer&&s.unshift(this.headers.Prefer),this.headers.Prefer=s.join(","),new t.default({method:"DELETE",url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}},p}function i(e){return"object"==typeof e&&null!==e&&"__isStorageError"in e}function o(e,t,s,r,n,i){return H(this,void 0,void 0,function*(){return new Promise((o,a)=>{e(s,((e,t,s,r)=>{const n={method:e,headers:(null==t?void 0:t.headers)||{}};return"GET"===e?n:(n.headers=Object.assign({"Content-Type":"application/json"},null==t?void 0:t.headers),r&&(n.body=JSON.stringify(r)),Object.assign(Object.assign({},n),s))})(t,r,n,i)).then(e=>{if(!e.ok)throw e;return(null==r?void 0:r.noResolveJson)?e:e.json()}).then(e=>o(e)).catch(e=>((e,t,s)=>H(void 0,void 0,void 0,function*(){const r=yield I(void 0,void 0,void 0,function*(){return"undefined"==typeof Response?(yield te(()=>Promise.resolve().then(()=>me),void 0)).Response:Response});e instanceof r&&!(null==s?void 0:s.noResolveJson)?e.json().then(s=>{t(new He(Ge(s),e.status||500))}).catch(e=>{t(new Je(Ge(e),e))}):t(new Je(Ge(e),e))}))(e,a,r))})})}function a(e,t,s,r){return H(this,void 0,void 0,function*(){return o(e,"GET",t,s,r)})}function h(e,t,s,r,n){return H(this,void 0,void 0,function*(){return o(e,"POST",t,r,n,s)})}function c(e,t,s,r,n){return H(this,void 0,void 0,function*(){return o(e,"DELETE",t,r,n,s)})}var l,u,d,f,p,m,g,v,y,b,_,w,j,P,k,E,T,O,C,R,S,$,A,x,L,D,B,U,N,M,F,I,H,J,z,q,G,V,K,W,Q,X,Y,Z,ee;import{_ as te}from"./lib-performance-J6WSP3tJ.js";import{at as se,a7 as re,au as ne}from"./vendor-other-DNtCu_aW.js";class ie extends Error{constructor(e,t="FunctionsError",s){super(e),this.name=t,this.context=s}}class oe extends ie{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class ae extends ie{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class he extends ie{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}(q=l||(l={})).Any="any",q.ApNortheast1="ap-northeast-1",q.ApNortheast2="ap-northeast-2",q.ApSouth1="ap-south-1",q.ApSoutheast1="ap-southeast-1",q.ApSoutheast2="ap-southeast-2",q.CaCentral1="ca-central-1",q.EuCentral1="eu-central-1",q.EuWest1="eu-west-1",q.EuWest2="eu-west-2",q.EuWest3="eu-west-3",q.SaEast1="sa-east-1",q.UsEast1="us-east-1",q.UsWest1="us-west-1",q.UsWest2="us-west-2",u=function(e,t,s,r){return new(s||(s=Promise))(function(n,i){function o(e){try{h(r.next(e))}catch(t){i(t)}}function a(e){try{h(r.throw(e))}catch(t){i(t)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(o,a)}h((r=r.apply(e,t||[])).next())})};class ce{constructor(e,{headers:t={},customFetch:s,region:r=l.Any}={}){this.url=e,this.headers=t,this.region=r,this.fetch=(e=>{let t;return t=e||("undefined"==typeof fetch?(...e)=>te(async()=>{const{default:e}=await Promise.resolve().then(()=>me);return{default:e}},void 0).then(({default:t})=>t(...e)):fetch),(...e)=>t(...e)})(s)}setAuth(e){this.headers.Authorization="Bearer "+e}invoke(e,t={}){var s;return u(this,void 0,void 0,function*(){try{const{headers:r,method:n,body:i}=t;let o={},{region:a}=t;a||(a=this.region);const h=new URL(`${this.url}/${e}`);let c;a&&"any"!==a&&(o["x-region"]=a,h.searchParams.set("forceFunctionRegion",a)),i&&(r&&!{}.hasOwnProperty.call(r,"Content-Type")||!r)&&("undefined"!=typeof Blob&&i instanceof Blob||i instanceof ArrayBuffer?(o["Content-Type"]="application/octet-stream",c=i):"string"==typeof i?(o["Content-Type"]="text/plain",c=i):"undefined"!=typeof FormData&&i instanceof FormData?c=i:(o["Content-Type"]="application/json",c=JSON.stringify(i)));const l=yield this.fetch(h.toString(),{method:n||"POST",headers:Object.assign(Object.assign(Object.assign({},o),this.headers),r),body:c}).catch(e=>{throw new oe(e)}),u=l.headers.get("x-relay-error");if(u&&"true"===u)throw new ae(l);if(!l.ok)throw new he(l);let d,f=(null!==(s=l.headers.get("Content-Type"))&&void 0!==s?s:"text/plain").split(";")[0].trim();return d="application/json"===f?yield l.json():"application/octet-stream"===f?yield l.blob():"text/event-stream"===f?l:"multipart/form-data"===f?yield l.formData():yield l.text(),{data:d,error:null,response:l}}catch(r){return{data:null,error:r,response:r instanceof he||r instanceof ae?r.context:void 0}}})}}d={},f={},p={},m={},g={},v={};const le=(y=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw Error("unable to locate global object")}()).fetch,ue=y.fetch.bind(y),de=y.Headers,fe=y.Request,pe=y.Response,me=Object.freeze(Object.defineProperty({__proto__:null,Headers:de,Request:fe,Response:pe,default:ue,fetch:le},Symbol.toStringTag,{value:"Module"})),ge=se(me);b={},E={},T={};const ve=re(function(){if(S)return d;S=1;var i=d&&d.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(d,"__esModule",{value:!0}),d.PostgrestError=d.PostgrestBuilder=d.PostgrestTransformBuilder=d.PostgrestFilterBuilder=d.PostgrestQueryBuilder=d.PostgrestClient=void 0;const o=i(function(){if(R)return f;R=1;var e=f&&f.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(f,"__esModule",{value:!0});const t=e(n()),s=e(r()),i=function(){if(C)return E;C=1,Object.defineProperty(E,"__esModule",{value:!0}),E.DEFAULT_HEADERS=void 0;const e=(O||(O=1,Object.defineProperty(T,"__esModule",{value:!0}),T.version=void 0,T.version="0.0.0-automated"),T);return E.DEFAULT_HEADERS={"X-Client-Info":"postgrest-js/"+e.version},E}();class o{constructor(e,{headers:t={},schema:s,fetch:r}={}){this.url=e,this.headers=Object.assign(Object.assign({},i.DEFAULT_HEADERS),t),this.schemaName=s,this.fetch=r}from(e){const s=new URL(`${this.url}/${e}`);return new t.default(s,{headers:Object.assign({},this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new o(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,t={},{head:r=!1,get:n=!1,count:i}={}){let o;const a=new URL(`${this.url}/rpc/${e}`);let h;r||n?(o=r?"HEAD":"GET",Object.entries(t).filter(([e,t])=>void 0!==t).map(([e,t])=>[e,Array.isArray(t)?`{${t.join(",")}}`:""+t]).forEach(([e,t])=>{a.searchParams.append(e,t)})):(o="POST",h=t);const c=Object.assign({},this.headers);return i&&(c.Prefer="count="+i),new s.default({method:o,url:a,headers:c,schema:this.schemaName,body:h,fetch:this.fetch,allowEmpty:!1})}}return f.default=o,f}());d.PostgrestClient=o.default;const a=i(n());d.PostgrestQueryBuilder=a.default;const h=i(r());d.PostgrestFilterBuilder=h.default;const c=i(s());d.PostgrestTransformBuilder=c.default;const l=i(t());d.PostgrestBuilder=l.default;const u=i(e());return d.PostgrestError=u.default,d.default={PostgrestClient:o.default,PostgrestQueryBuilder:a.default,PostgrestFilterBuilder:h.default,PostgrestTransformBuilder:c.default,PostgrestBuilder:l.default,PostgrestError:u.default},d}()),{PostgrestClient:ye,PostgrestQueryBuilder:be,PostgrestFilterBuilder:_e,PostgrestTransformBuilder:we,PostgrestBuilder:je,PostgrestError:Pe}=ve;(G=$||($={}))[G.connecting=0]="connecting",G[G.open=1]="open",G[G.closing=2]="closing",G[G.closed=3]="closed",(V=A||(A={})).closed="closed",V.errored="errored",V.joined="joined",V.joining="joining",V.leaving="leaving",(K=x||(x={})).close="phx_close",K.error="phx_error",K.join="phx_join",K.reply="phx_reply",K.leave="phx_leave",K.access_token="access_token",(L||(L={})).websocket="websocket",(W=D||(D={})).Connecting="connecting",W.Open="open",W.Closing="closing",W.Closed="closed";class ke{constructor(){this.HEADER_LENGTH=1}decode(e,t){return e.constructor===ArrayBuffer?t(this._binaryDecode(e)):t("string"==typeof e?JSON.parse(e):{})}_binaryDecode(e){const t=new DataView(e),s=new TextDecoder;return this._decodeBroadcast(e,t,s)}_decodeBroadcast(e,t,s){const r=t.getUint8(1),n=t.getUint8(2);let i=this.HEADER_LENGTH+2;const o=s.decode(e.slice(i,i+r));i+=r;const a=s.decode(e.slice(i,i+n));return i+=n,{ref:null,topic:o,event:a,payload:JSON.parse(s.decode(e.slice(i,e.byteLength)))}}}class Ee{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer)}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}(Q=B||(B={})).abstime="abstime",Q.bool="bool",Q.date="date",Q.daterange="daterange",Q.float4="float4",Q.float8="float8",Q.int2="int2",Q.int4="int4",Q.int4range="int4range",Q.int8="int8",Q.int8range="int8range",Q.json="json",Q.jsonb="jsonb",Q.money="money",Q.numeric="numeric",Q.oid="oid",Q.reltime="reltime",Q.text="text",Q.time="time",Q.timestamp="timestamp",Q.timestamptz="timestamptz",Q.timetz="timetz",Q.tsrange="tsrange",Q.tstzrange="tstzrange";const Te=(e,t,s={})=>{var r;const n=null!==(r=s.skipTypes)&&void 0!==r?r:[];return Object.keys(t).reduce((s,r)=>(s[r]=Oe(r,e,t,n),s),{})},Oe=(e,t,s,r)=>{const n=t.find(t=>t.name===e),i=null==n?void 0:n.type,o=s[e];return i&&!r.includes(i)?Ce(i,o):Re(o)},Ce=(e,t)=>{if("_"===e.charAt(0)){const s=e.slice(1,e.length);return xe(t,s)}switch(e){case B.bool:return Se(t);case B.float4:case B.float8:case B.int2:case B.int4:case B.int8:case B.numeric:case B.oid:return $e(t);case B.json:case B.jsonb:return Ae(t);case B.timestamp:return Le(t);case B.abstime:case B.date:case B.daterange:case B.int4range:case B.int8range:case B.money:case B.reltime:case B.text:case B.time:case B.timestamptz:case B.timetz:case B.tsrange:case B.tstzrange:default:return Re(t)}},Re=e=>e,Se=e=>{switch(e){case"t":return!0;case"f":return!1;default:return e}},$e=e=>{if("string"==typeof e){const t=parseFloat(e);if(!Number.isNaN(t))return t}return e},Ae=e=>{if("string"==typeof e)try{return JSON.parse(e)}catch(t){return e}return e},xe=(e,t)=>{if("string"!=typeof e)return e;const s=e.length-1,r=e[s];if("{"===e[0]&&"}"===r){let r;const i=e.slice(1,s);try{r=JSON.parse("["+i+"]")}catch(n){r=i?i.split(","):[]}return r.map(e=>Ce(t,e))}return e},Le=e=>"string"==typeof e?e.replace(" ","T"):e,De=e=>{let t=e;return t=t.replace(/^ws/i,"http"),t=t.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),t.replace(/\/+$/,"")};class Be{constructor(e,t,s={},r=1e4){this.channel=e,this.event=t,this.payload=s,this.timeout=r,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var s;return this._hasReceived(e)&&t(null===(s=this.receivedResp)||void 0===s?void 0:s.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){this.timeoutTimer||(this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref),this.channel._on(this.refEvent,{},e=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=e,this._matchReceive(e)}),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout))}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(t=>t.status===e).forEach(e=>e.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}(X=U||(U={})).SYNC="sync",X.JOIN="join",X.LEAVE="leave";class Ue{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const s=(null==t?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(s.state,{},e=>{const{onJoin:t,onLeave:s,onSync:r}=this.caller;this.joinRef=this.channel._joinRef(),this.state=Ue.syncState(this.state,e,t,s),this.pendingDiffs.forEach(e=>{this.state=Ue.syncDiff(this.state,e,t,s)}),this.pendingDiffs=[],r()}),this.channel._on(s.diff,{},e=>{const{onJoin:t,onLeave:s,onSync:r}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(e):(this.state=Ue.syncDiff(this.state,e,t,s),r())}),this.onJoin((e,t,s)=>{this.channel._trigger("presence",{event:"join",key:e,currentPresences:t,newPresences:s})}),this.onLeave((e,t,s)=>{this.channel._trigger("presence",{event:"leave",key:e,currentPresences:t,leftPresences:s})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,s,r){const n=this.cloneDeep(e),i=this.transformState(t),o={},a={};return this.map(n,(e,t)=>{i[e]||(a[e]=t)}),this.map(i,(e,t)=>{const s=n[e];if(s){const r=t.map(e=>e.presence_ref),n=s.map(e=>e.presence_ref),i=t.filter(e=>0>n.indexOf(e.presence_ref)),h=s.filter(e=>0>r.indexOf(e.presence_ref));i.length>0&&(o[e]=i),h.length>0&&(a[e]=h)}else o[e]=t}),this.syncDiff(n,{joins:o,leaves:a},s,r)}static syncDiff(e,t,s,r){const{joins:n,leaves:i}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return s||(s=()=>{}),r||(r=()=>{}),this.map(n,(t,r)=>{var n;const i=null!==(n=e[t])&&void 0!==n?n:[];if(e[t]=this.cloneDeep(r),i.length>0){const s=e[t].map(e=>e.presence_ref),r=i.filter(e=>0>s.indexOf(e.presence_ref));e[t].unshift(...r)}s(t,i,r)}),this.map(i,(t,s)=>{let n=e[t];if(!n)return;const i=s.map(e=>e.presence_ref);n=n.filter(e=>0>i.indexOf(e.presence_ref)),e[t]=n,r(t,n,s),0===n.length&&delete e[t]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(s=>t(s,e[s]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,s)=>{const r=e[s];return t[s]="metas"in r?r.metas.map(e=>(e.presence_ref=e.phx_ref,delete e.phx_ref,delete e.phx_ref_prev,e)):r,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}(Y=N||(N={})).ALL="*",Y.INSERT="INSERT",Y.UPDATE="UPDATE",Y.DELETE="DELETE",(Z=M||(M={})).BROADCAST="broadcast",Z.PRESENCE="presence",Z.POSTGRES_CHANGES="postgres_changes",Z.SYSTEM="system",(ee=F||(F={})).SUBSCRIBED="SUBSCRIBED",ee.TIMED_OUT="TIMED_OUT",ee.CLOSED="CLOSED",ee.CHANNEL_ERROR="CHANNEL_ERROR";class Ne{constructor(e,t={config:{}},s){this.topic=e,this.params=t,this.socket=s,this.bindings={},this.state=A.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:""},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new Be(this,x.join,this.params,this.timeout),this.rejoinTimer=new Ee(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=A.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(e=>e.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=A.closed,this.socket._remove(this)}),this._onError(e=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel","error "+this.topic,e),this.state=A.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel","timeout "+this.topic,this.joinPush.timeout),this.state=A.errored,this.rejoinTimer.scheduleTimeout())}),this._on(x.reply,{},(e,t)=>{this._trigger(this._replyEventName(t),e)}),this.presence=new Ue(this),this.broadcastEndpointURL=De(this.socket.endPoint)+"/api/broadcast",this.private=this.params.config.private||!1}subscribe(e,t=this.timeout){var s,r;if(this.socket.isConnected()||this.socket.connect(),this.state==A.closed){const{config:{broadcast:n,presence:i,private:o}}=this.params;this._onError(t=>null==e?void 0:e(F.CHANNEL_ERROR,t)),this._onClose(()=>null==e?void 0:e(F.CLOSED));const a={},h={broadcast:n,presence:i,postgres_changes:null!==(r=null===(s=this.bindings.postgres_changes)||void 0===s?void 0:s.map(e=>e.filter))&&void 0!==r?r:[],private:o};this.socket.accessTokenValue&&(a.access_token=this.socket.accessTokenValue),this.updateJoinPayload(Object.assign({config:h},a)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:t})=>{var s;if(this.socket.setAuth(),void 0!==t){const r=this.bindings.postgres_changes,n=null!==(s=null==r?void 0:r.length)&&void 0!==s?s:0,i=[];for(let s=0;n>s;s++){const n=r[s],{filter:{event:o,schema:a,table:h,filter:c}}=n,l=t&&t[s];if(!l||l.event!==o||l.schema!==a||l.table!==h||l.filter!==c)return this.unsubscribe(),this.state=A.errored,void(null==e||e(F.CHANNEL_ERROR,Error("mismatch between server and client bindings for postgres changes")));i.push(Object.assign(Object.assign({},n),{id:l.id}))}return this.bindings.postgres_changes=i,void(e&&e(F.SUBSCRIBED))}null==e||e(F.SUBSCRIBED)}).receive("error",t=>{this.state=A.errored,null==e||e(F.CHANNEL_ERROR,Error(JSON.stringify(Object.values(t).join(", ")||"error")))}).receive("timeout",()=>{null==e||e(F.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,s){return this._on(e,t,s)}async send(e,t={}){var s,r;if(this._canPush()||"broadcast"!==e.type)return new Promise(s=>{var r,n,i;const o=this._push(e.type,e,t.timeout||this.timeout);"broadcast"!==e.type||(null===(i=null===(n=null===(r=this.params)||void 0===r?void 0:r.config)||void 0===n?void 0:n.broadcast)||void 0===i?void 0:i.ack)||s("ok"),o.receive("ok",()=>s("ok")),o.receive("error",()=>s("error")),o.receive("timeout",()=>s("timed out"))});{const{event:i,payload:o}=e,a={method:"POST",headers:{Authorization:this.socket.accessTokenValue?"Bearer "+this.socket.accessTokenValue:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:i,payload:o,private:this.private}]})};try{const e=await this._fetchWithTimeout(this.broadcastEndpointURL,a,null!==(s=t.timeout)&&void 0!==s?s:this.timeout);return await(null===(r=e.body)||void 0===r?void 0:r.cancel()),e.ok?"ok":"error"}catch(n){return"AbortError"===n.name?"timed out":"error"}}}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=A.leaving;const t=()=>{this.socket.log("channel","leave "+this.topic),this._trigger(x.close,"leave",this._joinRef())};this.joinPush.destroy();let s=null;return new Promise(r=>{s=new Be(this,x.leave,{},e),s.receive("ok",()=>{t(),r("ok")}).receive("timeout",()=>{t(),r("timed out")}).receive("error",()=>{r("error")}),s.send(),this._canPush()||s.trigger("ok",{})}).finally(()=>{null==s||s.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.rejoinTimer&&clearTimeout(this.rejoinTimer.timer),this.joinPush.destroy()}async _fetchWithTimeout(e,t,s){const r=new AbortController,n=setTimeout(()=>r.abort(),s),i=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:r.signal}));return clearTimeout(n),i}_push(e,t,s=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let r=new Be(this,e,t,s);return this._canPush()?r.send():(r.startTimeout(),this.pushBuffer.push(r)),r}_onMessage(e,t,s){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,s){var r,n;const i=e.toLocaleLowerCase(),{close:o,error:a,leave:h,join:c}=x;if(s&&[o,a,h,c].indexOf(i)>=0&&s!==this._joinRef())return;let l=this._onMessage(i,t,s);if(t&&!l)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(i)?null===(r=this.bindings.postgres_changes)||void 0===r||r.filter(e=>{var t,s,r;return"*"===(null===(t=e.filter)||void 0===t?void 0:t.event)||(null===(r=null===(s=e.filter)||void 0===s?void 0:s.event)||void 0===r?void 0:r.toLocaleLowerCase())===i}).map(e=>e.callback(l,s)):null===(n=this.bindings[i])||void 0===n||n.filter(e=>{var s,r,n,o,a,h;if(["broadcast","presence","postgres_changes"].includes(i)){if("id"in e){const i=e.id,o=null===(s=e.filter)||void 0===s?void 0:s.event;return i&&(null===(r=t.ids)||void 0===r?void 0:r.includes(i))&&("*"===o||(null==o?void 0:o.toLocaleLowerCase())===(null===(n=t.data)||void 0===n?void 0:n.type.toLocaleLowerCase()))}{const s=null===(a=null===(o=null==e?void 0:e.filter)||void 0===o?void 0:o.event)||void 0===a?void 0:a.toLocaleLowerCase();return"*"===s||s===(null===(h=null==t?void 0:t.event)||void 0===h?void 0:h.toLocaleLowerCase())}}return e.type.toLocaleLowerCase()===i}).map(e=>{if("object"==typeof l&&"ids"in l){const e=l.data,{schema:t,table:s,commit_timestamp:r,type:n,errors:i}=e;l=Object.assign(Object.assign({},{schema:t,table:s,commit_timestamp:r,eventType:n,new:{},old:{},errors:i}),this._getPayloadRecords(e))}e.callback(l,s)})}_isClosed(){return this.state===A.closed}_isJoined(){return this.state===A.joined}_isJoining(){return this.state===A.joining}_isLeaving(){return this.state===A.leaving}_replyEventName(e){return"chan_reply_"+e}_on(e,t,s){const r=e.toLocaleLowerCase(),n={type:r,filter:t,callback:s};return this.bindings[r]?this.bindings[r].push(n):this.bindings[r]=[n],this}_off(e,t){const s=e.toLocaleLowerCase();return this.bindings[s]=this.bindings[s].filter(e=>{var r;return!((null===(r=e.type)||void 0===r?void 0:r.toLocaleLowerCase())===s&&Ne.isEqual(e.filter,t))}),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const s in e)if(e[s]!==t[s])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(x.close,{},e)}_onError(e){this._on(x.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=A.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return"INSERT"!==e.type&&"UPDATE"!==e.type||(t.new=Te(e.columns,e.record)),"UPDATE"!==e.type&&"DELETE"!==e.type||(t.old=Te(e.columns,e.old_record)),t}}const Me=()=>{};class Fe{constructor(e,t){var s;this.accessTokenValue=null,this.apiKey=null,this.channels=[],this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=1e4,this.heartbeatIntervalMs=25e3,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=Me,this.ref=0,this.logger=Me,this.conn=null,this.sendBuffer=[],this.serializer=new ke,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._resolveFetch=e=>{let t;return t=e||("undefined"==typeof fetch?(...e)=>te(async()=>{const{default:e}=await Promise.resolve().then(()=>me);return{default:e}},void 0).then(({default:t})=>t(...e)):fetch),(...e)=>t(...e)},this.endPoint=`${e}/${L.websocket}`,this.httpEndpoint=De(e),(null==t?void 0:t.transport)?this.transport=t.transport:this.transport=null,(null==t?void 0:t.params)&&(this.params=t.params),(null==t?void 0:t.timeout)&&(this.timeout=t.timeout),(null==t?void 0:t.logger)&&(this.logger=t.logger),((null==t?void 0:t.logLevel)||(null==t?void 0:t.log_level))&&(this.logLevel=t.logLevel||t.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),(null==t?void 0:t.heartbeatIntervalMs)&&(this.heartbeatIntervalMs=t.heartbeatIntervalMs);const r=null===(s=null==t?void 0:t.params)||void 0===s?void 0:s.apikey;if(r&&(this.accessTokenValue=r,this.apiKey=r),this.reconnectAfterMs=(null==t?void 0:t.reconnectAfterMs)?t.reconnectAfterMs:e=>[1e3,2e3,5e3,1e4][e-1]||1e4,this.encode=(null==t?void 0:t.encode)?t.encode:(e,t)=>t(JSON.stringify(e)),this.decode=(null==t?void 0:t.decode)?t.decode:this.serializer.decode.bind(this.serializer),this.reconnectTimer=new Ee(async()=>{this.disconnect(),this.connect()},this.reconnectAfterMs),this.fetch=this._resolveFetch(null==t?void 0:t.fetch),null==t?void 0:t.worker){if("undefined"!=typeof window&&!window.Worker)throw Error("Web Worker is not supported");this.worker=(null==t?void 0:t.worker)||!1,this.workerUrl=null==t?void 0:t.workerUrl}this.accessToken=(null==t?void 0:t.accessToken)||null}connect(){if(!this.conn){if(this.transport||(this.transport=ne),!this.transport)throw Error("No transport provided");this.conn=new this.transport(this.endpointURL()),this.setupConnection()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:"1.0.0"}))}disconnect(e,t){this.conn&&(this.conn.onclose=function(){},e?this.conn.close(e,null!=t?t:""):this.conn.close(),this.conn=null,this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.reset(),this.channels.forEach(e=>e.teardown()))}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return 0===this.channels.length&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(e=>e.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,t,s){this.logger(e,t,s)}connectionState(){switch(this.conn&&this.conn.readyState){case $.connecting:return D.Connecting;case $.open:return D.Open;case $.closing:return D.Closing;default:return D.Closed}}isConnected(){return this.connectionState()===D.Open}channel(e,t={config:{}}){const s="realtime:"+e,r=this.getChannels().find(e=>e.topic===s);if(r)return r;{const s=new Ne("realtime:"+e,t,this);return this.channels.push(s),s}}push(e){const{topic:t,event:s,payload:r,ref:n}=e,i=()=>{this.encode(e,e=>{var t;null===(t=this.conn)||void 0===t||t.send(e)})};this.log("push",`${t} ${s} (${n})`,r),this.isConnected()?i():this.sendBuffer.push(i)}async setAuth(e=null){let t=e||this.accessToken&&await this.accessToken()||this.accessTokenValue;this.accessTokenValue!=t&&(this.accessTokenValue=t,this.channels.forEach(e=>{const s={access_token:t,version:"realtime-js/2.11.15"};t&&e.updateJoinPayload(s),e.joinedOnce&&e._isJoined()&&e._push(x.access_token,{access_token:t})}))}async sendHeartbeat(){var e;if(this.isConnected()){if(this.pendingHeartbeatRef)return this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection"),this.heartbeatCallback("timeout"),void(null===(e=this.conn)||void 0===e||e.close(1e3,"hearbeat timeout"));this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.heartbeatCallback("sent"),await this.setAuth()}else this.heartbeatCallback("disconnected")}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(t=>t.topic===e&&(t._isJoined()||t._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t.topic!==e.topic)}setupConnection(){this.conn&&(this.conn.binaryType="arraybuffer",this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_onConnMessage(e){this.decode(e.data,e=>{let{topic:t,event:s,payload:r,ref:n}=e;"phoenix"===t&&"phx_reply"===s&&this.heartbeatCallback("ok"==e.payload.status?"ok":"error"),n&&n===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null),this.log("receive",`${r.status||""} ${t} ${s} ${n&&"("+n+")"||""}`,r),Array.from(this.channels).filter(e=>e._isMember(t)).forEach(e=>e._trigger(s,r,n)),this.stateChangeCallbacks.message.forEach(t=>t(e))})}_onConnOpen(){this.log("transport","connected to "+this.endpointURL()),this.flushSendBuffer(),this.reconnectTimer.reset(),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this.stateChangeCallbacks.open.forEach(e=>e())}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker","starting worker for from "+this.workerUrl):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=e=>{this.log("worker","worker error",e.message),this.workerRef.terminate()},this.workerRef.onmessage=e=>{"keepAlive"===e.data.event&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_onConnClose(e){this.log("transport","close",e),this._triggerChanError(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach(t=>t(e))}_onConnError(e){this.log("transport",""+e),this._triggerChanError(),this.stateChangeCallbacks.error.forEach(t=>t(e))}_triggerChanError(){this.channels.forEach(e=>e._trigger(x.error))}_appendParams(e,t){if(0===Object.keys(t).length)return e;const s=e.match(/\?/)?"&":"?";return`${e}${s}${new URLSearchParams(t)}`}_workerObjectUrl(e){let t;if(e)t=e;else{const e=new Blob(['\n  addEventListener("message", (e) => {\n    if (e.data.event === "start") {\n      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);\n    }\n  });'],{type:"application/javascript"});t=URL.createObjectURL(e)}return t}}class Ie extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}class He extends Ie{constructor(e,t){super(e),this.name="StorageApiError",this.status=t}toJSON(){return{name:this.name,message:this.message,status:this.status}}}class Je extends Ie{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}I=function(e,t,s,r){return new(s||(s=Promise))(function(n,i){function o(e){try{h(r.next(e))}catch(t){i(t)}}function a(e){try{h(r.throw(e))}catch(t){i(t)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(o,a)}h((r=r.apply(e,t||[])).next())})};const ze=e=>{let t;return t=e||("undefined"==typeof fetch?(...e)=>te(async()=>{const{default:e}=await Promise.resolve().then(()=>me);return{default:e}},void 0).then(({default:t})=>t(...e)):fetch),(...e)=>t(...e)},qe=e=>{if(Array.isArray(e))return e.map(e=>qe(e));if("function"==typeof e||e!==Object(e))return e;const t={};return Object.entries(e).forEach(([e,s])=>{const r=e.replace(/([-_][a-z])/gi,e=>e.toUpperCase().replace(/[-_]/g,""));t[r]=qe(s)}),t};H=function(e,t,s,r){return new(s||(s=Promise))(function(n,i){function o(e){try{h(r.next(e))}catch(t){i(t)}}function a(e){try{h(r.throw(e))}catch(t){i(t)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(o,a)}h((r=r.apply(e,t||[])).next())})};const Ge=e=>e.msg||e.message||e.error_description||e.error||JSON.stringify(e);J=function(e,t,s,r){return new(s||(s=Promise))(function(n,i){function o(e){try{h(r.next(e))}catch(t){i(t)}}function a(e){try{h(r.throw(e))}catch(t){i(t)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(o,a)}h((r=r.apply(e,t||[])).next())})};const Ve={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},Ke={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class We{constructor(e,t={},s,r){this.url=e,this.headers=t,this.bucketId=s,this.fetch=ze(r)}uploadOrUpdate(e,t,s,r){return J(this,void 0,void 0,function*(){try{let n;const i=Object.assign(Object.assign({},Ke),r);let o=Object.assign(Object.assign({},this.headers),"POST"===e&&{"x-upsert":i.upsert+""});const a=i.metadata;"undefined"!=typeof Blob&&s instanceof Blob?(n=new FormData,n.append("cacheControl",i.cacheControl),a&&n.append("metadata",this.encodeMetadata(a)),n.append("",s)):"undefined"!=typeof FormData&&s instanceof FormData?(n=s,n.append("cacheControl",i.cacheControl),a&&n.append("metadata",this.encodeMetadata(a))):(n=s,o["cache-control"]="max-age="+i.cacheControl,o["content-type"]=i.contentType,a&&(o["x-metadata"]=this.toBase64(this.encodeMetadata(a)))),(null==r?void 0:r.headers)&&(o=Object.assign(Object.assign({},o),r.headers));const h=this._removeEmptyFolders(t),c=this._getFinalPath(h),l=yield this.fetch(`${this.url}/object/${c}`,Object.assign({method:e,body:n,headers:o},(null==i?void 0:i.duplex)?{duplex:i.duplex}:{})),u=yield l.json();return l.ok?{data:{path:h,id:u.Id,fullPath:u.Key},error:null}:{data:null,error:u}}catch(n){if(i(n))return{data:null,error:n};throw n}})}upload(e,t,s){return J(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,s)})}uploadToSignedUrl(e,t,s,r){return J(this,void 0,void 0,function*(){const n=this._removeEmptyFolders(e),o=this._getFinalPath(n),a=new URL(this.url+"/object/upload/sign/"+o);a.searchParams.set("token",t);try{let e;const t=Object.assign({upsert:Ke.upsert},r),i=Object.assign(Object.assign({},this.headers),{"x-upsert":t.upsert+""});"undefined"!=typeof Blob&&s instanceof Blob?(e=new FormData,e.append("cacheControl",t.cacheControl),e.append("",s)):"undefined"!=typeof FormData&&s instanceof FormData?(e=s,e.append("cacheControl",t.cacheControl)):(e=s,i["cache-control"]="max-age="+t.cacheControl,i["content-type"]=t.contentType);const o=yield this.fetch(a.toString(),{method:"PUT",body:e,headers:i}),h=yield o.json();return o.ok?{data:{path:n,fullPath:h.Key},error:null}:{data:null,error:h}}catch(h){if(i(h))return{data:null,error:h};throw h}})}createSignedUploadUrl(e,t){return J(this,void 0,void 0,function*(){try{let s=this._getFinalPath(e);const r=Object.assign({},this.headers);(null==t?void 0:t.upsert)&&(r["x-upsert"]="true");const n=yield h(this.fetch,`${this.url}/object/upload/sign/${s}`,{},{headers:r}),i=new URL(this.url+n.url),o=i.searchParams.get("token");if(!o)throw new Ie("No token returned by API");return{data:{signedUrl:i.toString(),path:e,token:o},error:null}}catch(s){if(i(s))return{data:null,error:s};throw s}})}update(e,t,s){return J(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,s)})}move(e,t,s){return J(this,void 0,void 0,function*(){try{return{data:yield h(this.fetch,this.url+"/object/move",{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:null==s?void 0:s.destinationBucket},{headers:this.headers}),error:null}}catch(r){if(i(r))return{data:null,error:r};throw r}})}copy(e,t,s){return J(this,void 0,void 0,function*(){try{return{data:{path:(yield h(this.fetch,this.url+"/object/copy",{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:null==s?void 0:s.destinationBucket},{headers:this.headers})).Key},error:null}}catch(r){if(i(r))return{data:null,error:r};throw r}})}createSignedUrl(e,t,s){return J(this,void 0,void 0,function*(){try{let r=this._getFinalPath(e),n=yield h(this.fetch,`${this.url}/object/sign/${r}`,Object.assign({expiresIn:t},(null==s?void 0:s.transform)?{transform:s.transform}:{}),{headers:this.headers});const i=(null==s?void 0:s.download)?"&download="+(!0===s.download?"":s.download):"";return n={signedUrl:encodeURI(`${this.url}${n.signedURL}${i}`)},{data:n,error:null}}catch(r){if(i(r))return{data:null,error:r};throw r}})}createSignedUrls(e,t,s){return J(this,void 0,void 0,function*(){try{const r=yield h(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),n=(null==s?void 0:s.download)?"&download="+(!0===s.download?"":s.download):"";return{data:r.map(e=>Object.assign(Object.assign({},e),{signedUrl:e.signedURL?encodeURI(`${this.url}${e.signedURL}${n}`):null})),error:null}}catch(r){if(i(r))return{data:null,error:r};throw r}})}download(e,t){return J(this,void 0,void 0,function*(){const s=void 0!==(null==t?void 0:t.transform)?"render/image/authenticated":"object",r=this.transformOptsToQueryString((null==t?void 0:t.transform)||{}),n=r?"?"+r:"";try{const t=this._getFinalPath(e),r=yield a(this.fetch,`${this.url}/${s}/${t}${n}`,{headers:this.headers,noResolveJson:!0});return{data:yield r.blob(),error:null}}catch(o){if(i(o))return{data:null,error:o};throw o}})}info(e){return J(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{const e=yield a(this.fetch,`${this.url}/object/info/${t}`,{headers:this.headers});return{data:qe(e),error:null}}catch(s){if(i(s))return{data:null,error:s};throw s}})}exists(e){return J(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{return yield function(e,t,s){return H(this,void 0,void 0,function*(){return o(e,"HEAD",t,Object.assign(Object.assign({},s),{noResolveJson:!0}),void 0)})}(this.fetch,`${this.url}/object/${t}`,{headers:this.headers}),{data:!0,error:null}}catch(s){if(i(s)&&s instanceof Je){const e=s.originalError;if([400,404].includes(null==e?void 0:e.status))return{data:!1,error:s}}throw s}})}getPublicUrl(e,t){const s=this._getFinalPath(e),r=[],n=(null==t?void 0:t.download)?"download="+(!0===t.download?"":t.download):"";""!==n&&r.push(n);const i=void 0!==(null==t?void 0:t.transform)?"render/image":"object",o=this.transformOptsToQueryString((null==t?void 0:t.transform)||{});""!==o&&r.push(o);let a=r.join("&");return""!==a&&(a="?"+a),{data:{publicUrl:encodeURI(`${this.url}/${i}/public/${s}${a}`)}}}remove(e){return J(this,void 0,void 0,function*(){try{return{data:yield c(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(i(t))return{data:null,error:t};throw t}})}list(e,t,s){return J(this,void 0,void 0,function*(){try{const r=Object.assign(Object.assign(Object.assign({},Ve),t),{prefix:e||""});return{data:yield h(this.fetch,`${this.url}/object/list/${this.bucketId}`,r,{headers:this.headers},s),error:null}}catch(r){if(i(r))return{data:null,error:r};throw r}})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return"undefined"!=typeof Buffer?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push("width="+e.width),e.height&&t.push("height="+e.height),e.resize&&t.push("resize="+e.resize),e.format&&t.push("format="+e.format),e.quality&&t.push("quality="+e.quality),t.join("&")}}const Qe={"X-Client-Info":"storage-js/2.7.1"};z=function(e,t,s,r){return new(s||(s=Promise))(function(n,i){function o(e){try{h(r.next(e))}catch(t){i(t)}}function a(e){try{h(r.throw(e))}catch(t){i(t)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(o,a)}h((r=r.apply(e,t||[])).next())})};class Xe{constructor(e,t={},s){this.url=e,this.headers=Object.assign(Object.assign({},Qe),t),this.fetch=ze(s)}listBuckets(){return z(this,void 0,void 0,function*(){try{return{data:yield a(this.fetch,this.url+"/bucket",{headers:this.headers}),error:null}}catch(e){if(i(e))return{data:null,error:e};throw e}})}getBucket(e){return z(this,void 0,void 0,function*(){try{return{data:yield a(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(i(t))return{data:null,error:t};throw t}})}createBucket(e,t={public:!1}){return z(this,void 0,void 0,function*(){try{return{data:yield h(this.fetch,this.url+"/bucket",{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(s){if(i(s))return{data:null,error:s};throw s}})}updateBucket(e,t){return z(this,void 0,void 0,function*(){try{const s=yield function(e,t,s,r){return H(this,void 0,void 0,function*(){return o(e,"PUT",t,r,void 0,s)})}(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers});return{data:s,error:null}}catch(s){if(i(s))return{data:null,error:s};throw s}})}emptyBucket(e){return z(this,void 0,void 0,function*(){try{return{data:yield h(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(i(t))return{data:null,error:t};throw t}})}deleteBucket(e){return z(this,void 0,void 0,function*(){try{return{data:yield c(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(i(t))return{data:null,error:t};throw t}})}}class Ye extends Xe{constructor(e,t={},s){super(e,t,s)}from(e){return new We(this.url,this.headers,e,this.fetch)}}export{ce as F,de as H,ye as P,Fe as R,Ye as S,me as b,ue as n};
