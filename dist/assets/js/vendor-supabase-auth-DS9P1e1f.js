const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/vendor-supabase-Dzta5LwM.js","assets/js/lib-performance-J6WSP3tJ.js","assets/js/vendor-other-DNtCu_aW.js"])))=>i.map(i=>d[i]);
function e(e){return"object"==typeof e&&null!==e&&"__isAuthError"in e}function t(t){return e(t)&&"AuthRetryableFetchError"===t.name}function s(e,t,s){if(null!==e)for(t.queue=t.queue<<8|e,t.queuedBits+=8;t.queuedBits>=6;){const e=t.queue>>t.queuedBits-6&63;s(G[e]),t.queuedBits-=6}else if(t.queuedBits>0)for(t.queue=t.queue<<6-t.queuedBits,t.queuedBits=6;t.queuedBits>=6;){const e=t.queue>>t.queuedBits-6&63;s(G[e]),t.queuedBits-=6}}function r(e,t,s){const r=V[e];if(-1>=r){if(-2===r)return;throw Error(`Invalid Base64-URL character "${String.fromCharCode(e)}"`)}for(t.queue=t.queue<<6|r,t.queuedBits+=6;t.queuedBits>=8;)s(t.queue>>t.queuedBits-8&255),t.queuedBits-=8}function i(e){const t=[],s=e=>{t.push(String.fromCodePoint(e))},i={utf8seq:0,codepoint:0},a={queue:0,queuedBits:0},n=e=>{!function(e,t,s){if(0===t.utf8seq){if(127>=e)return void s(e);for(let s=1;6>s;s+=1)if(!(e>>7-s&1)){t.utf8seq=s;break}if(2===t.utf8seq)t.codepoint=31&e;else if(3===t.utf8seq)t.codepoint=15&e;else{if(4!==t.utf8seq)throw Error("Invalid UTF-8 sequence");t.codepoint=7&e}t.utf8seq-=1}else if(t.utf8seq>0){if(127>=e)throw Error("Invalid UTF-8 sequence");t.codepoint=t.codepoint<<6|63&e,t.utf8seq-=1,0===t.utf8seq&&s(t.codepoint)}}(e,i,s)};for(let o=0;o<e.length;o+=1)r(e.charCodeAt(o),a,n);return t.join("")}function a(e,t){if(e>127){if(2047>=e)return t(192|e>>6),void t(128|63&e);if(65535>=e)return t(224|e>>12),t(128|e>>6&63),void t(128|63&e);if(1114111>=e)return t(240|e>>18),t(128|e>>12&63),t(128|e>>6&63),void t(128|63&e);throw Error("Unrecognized Unicode codepoint: "+e.toString(16))}t(e)}function n(e){const t=[],s={queue:0,queuedBits:0},i=e=>{t.push(e)};for(let a=0;a<e.length;a+=1)r(e.charCodeAt(a),s,i);return new Uint8Array(t)}function o(e){const t=[],r={queue:0,queuedBits:0},i=e=>{t.push(e)};return e.forEach(e=>s(e,r,i)),s(null,r,i),t.join("")}function l(e){const t=e.split(".");if(3!==t.length)throw new z("Invalid JWT structure");for(let s=0;s<t.length;s++)if(!R.test(t[s]))throw new z("JWT not in base64url format");return{header:JSON.parse(i(t[0])),payload:JSON.parse(i(t[1])),signature:n(t[2]),raw:{header:t[0],payload:t[1]}}}function u(e){return("0"+e.toString(16)).substr(-2)}async function c(e,t,s=!1){const r=function(){const e=new Uint32Array(56);if("undefined"==typeof crypto){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",t=e.length;let s="";for(let r=0;56>r;r++)s+=e.charAt(Math.floor(Math.random()*t));return s}return crypto.getRandomValues(e),Array.from(e,u).join("")}();let i=r;s&&(i+="/PASSWORD_RECOVERY"),await Z(e,t+"-code-verifier",i);const a=await async function(e){if("undefined"==typeof crypto||void 0===crypto.subtle||"undefined"==typeof TextEncoder)return e;const t=await async function(e){const t=(new TextEncoder).encode(e),s=await crypto.subtle.digest("SHA-256",t),r=new Uint8Array(s);return Array.from(r).map(e=>String.fromCharCode(e)).join("")}(e);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}(r);return[a,r===a?"plain":"s256"]}function h(e){if(!re.test(e))throw Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function d(){return new Proxy({},{get:(e,t)=>{if("__isUserNotAvailableProxy"===t)return!0;if("symbol"==typeof t){const e=t.toString();if("Symbol(Symbol.toPrimitive)"===e||"Symbol(Symbol.toStringTag)"===e||"Symbol(util.inspect.custom)"===e)return}throw Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${t}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,t)=>{throw Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,t)=>{throw Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}async function f(e){var t,s;if(!("object"==typeof(s=e)&&null!==s&&"status"in s&&"ok"in s&&"json"in s&&"function"==typeof s.json))throw new M(ie(e),0);if(ae.includes(e.status))throw new M(ie(e),e.status);let r,i;try{r=await e.json()}catch(n){throw new U(ie(n),n)}const a=function(e){const t=e.headers.get(O);if(!t)return null;if(!t.match(se))return null;try{return new Date(t+"T00:00:00.0Z")}catch(n){return null}}(e);if(a&&a.getTime()>=P.timestamp&&"object"==typeof r&&r&&"string"==typeof r.code?i=r.code:"object"==typeof r&&r&&"string"==typeof r.error_code&&(i=r.error_code),i){if("weak_password"===i)throw new B(ie(r),e.status,(null===(t=r.weak_password)||void 0===t?void 0:t.reasons)||[]);if("session_not_found"===i)throw new D}else if("object"==typeof r&&r&&"object"==typeof r.weak_password&&r.weak_password&&Array.isArray(r.weak_password.reasons)&&r.weak_password.reasons.length&&r.weak_password.reasons.reduce((e,t)=>e&&"string"==typeof t,!0))throw new B(ie(r),e.status,r.weak_password.reasons);throw new q(ie(r),e.status||500,i)}async function g(e,t,s,r){var i;const a=Object.assign({},null==r?void 0:r.headers);a[O]||(a[O]=P.name),(null==r?void 0:r.jwt)&&(a.Authorization="Bearer "+r.jwt);const n=null!==(i=null==r?void 0:r.query)&&void 0!==i?i:{};(null==r?void 0:r.redirectTo)&&(n.redirect_to=r.redirectTo);const o=Object.keys(n).length?"?"+new URLSearchParams(n).toString():"",l=await async function(e,t,s,r,i,a){const n=((e,t,s,r)=>{const i={method:e,headers:(null==t?void 0:t.headers)||{}};return"GET"===e?i:(i.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},null==t?void 0:t.headers),i.body=JSON.stringify(r),Object.assign(Object.assign({},i),{}))})(t,r,0,a);let o;try{o=await e(s,Object.assign({},n))}catch(l){throw new M(ie(l),0)}if(o.ok||await f(o),null==r?void 0:r.noResolveJson)return o;try{return await o.json()}catch(l){await f(l)}}(e,t,s+o,{headers:a,noResolveJson:null==r?void 0:r.noResolveJson},0,null==r?void 0:r.body);return(null==r?void 0:r.xform)?null==r?void 0:r.xform(l):{data:Object.assign({},l),error:null}}function w(e){var t,s;let r=null;return function(e){return e.access_token&&e.refresh_token&&e.expires_in}(e)&&(r=Object.assign({},e),e.expires_at||(r.expires_at=(s=e.expires_in,Math.round(Date.now()/1e3)+s))),{data:{session:r,user:null!==(t=e.user)&&void 0!==t?t:e},error:null}}function y(e){const t=w(e);return!t.error&&e.weak_password&&"object"==typeof e.weak_password&&Array.isArray(e.weak_password.reasons)&&e.weak_password.reasons.length&&e.weak_password.message&&"string"==typeof e.weak_password.message&&e.weak_password.reasons.reduce((e,t)=>e&&"string"==typeof t,!0)&&(t.data.weak_password=e.weak_password),t}function _(e){var t;return{data:{user:null!==(t=e.user)&&void 0!==t?t:e},error:null}}function p(e){return{data:e,error:null}}function v(e){const{action_link:t,email_otp:s,hashed_token:r,redirect_to:i,verification_type:a}=e,n=T(e,["action_link","email_otp","hashed_token","redirect_to","verification_type"]);return{data:{properties:{action_link:t,email_otp:s,hashed_token:r,redirect_to:i,verification_type:a},user:Object.assign({},n)},error:null}}function b(e){return e}function m(e={}){return{getItem:t=>e[t]||null,setItem:(t,s)=>{e[t]=s},removeItem:t=>{delete e[t]}}}async function k(e,t,s){const r=new globalThis.AbortController;return t>0&&setTimeout(()=>{r.abort()},t),await Promise.resolve().then(()=>globalThis.navigator.locks.request(e,0===t?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:r.signal},async r=>{if(!r){if(0===t)throw new ce(`Acquiring an exclusive Navigator LockManager lock "${e}" immediately failed`);if(le)try{await globalThis.navigator.locks.query()}catch(i){}return await s()}try{return await s()}finally{}}))}async function S(e,t,s){return await s()}var T,I;import{_ as A}from"./lib-performance-J6WSP3tJ.js";const E="2.71.0",x=3e4,j={"X-Client-Info":"gotrue-js/"+E},O="X-Supabase-Api-Version",P={timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"},R=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i;class C extends Error{constructor(e,t,s){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=s}}class q extends C{constructor(e,t,s){super(e,t,s),this.name="AuthApiError",this.status=t,this.code=s}}class U extends C{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class L extends C{constructor(e,t,s,r){super(e,s,r),this.name=t,this.status=s}}class D extends L{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}class N extends L{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class K extends L{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class $ extends L{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class W extends L{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class M extends L{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}class B extends L{constructor(e,t,s){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=s}}class z extends L{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const G="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),F=" \t\n\r=".split(""),V=(()=>{const e=Array(128);for(let t=0;t<e.length;t+=1)e[t]=-1;for(let t=0;t<F.length;t+=1)e[F[t].charCodeAt(0)]=-2;for(let t=0;t<G.length;t+=1)e[G[t].charCodeAt(0)]=t;return e})(),J=()=>"undefined"!=typeof window&&"undefined"!=typeof document,H={tested:!1,writable:!1},Y=()=>{if(!J())return!1;try{if("object"!=typeof globalThis.localStorage)return!1}catch(t){return!1}if(H.tested)return H.writable;const e=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(e,e),globalThis.localStorage.removeItem(e),H.tested=!0,H.writable=!0}catch(t){H.tested=!0,H.writable=!1}return H.writable},X=e=>{let t;return t=e||("undefined"==typeof fetch?(...e)=>A(async()=>{const{default:e}=await import("./vendor-supabase-Dzta5LwM.js").then(e=>e.b);return{default:e}},__vite__mapDeps([0,1,2])).then(({default:t})=>t(...e)):fetch),(...e)=>t(...e)},Z=async(e,t,s)=>{await e.setItem(t,JSON.stringify(s))},Q=async(e,t)=>{const s=await e.getItem(t);if(!s)return null;try{return JSON.parse(s)}catch(r){return s}},ee=async(e,t)=>{await e.removeItem(t)};class te{constructor(){this.promise=new te.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}te.promiseConstructor=Promise;const se=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i,re=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;T=function(e,t){var s,r,i={};for(s in e)({}).hasOwnProperty.call(e,s)&&0>t.indexOf(s)&&(i[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(r=0,s=Object.getOwnPropertySymbols(e);r<s.length;r++)0>t.indexOf(s[r])&&{}.propertyIsEnumerable.call(e,s[r])&&(i[s[r]]=e[s[r]]);return i};const ie=e=>e.msg||e.message||e.error_description||e.error||JSON.stringify(e),ae=[502,503,504],ne=["global","local","others"];I=function(e,t){var s,r,i={};for(s in e)({}).hasOwnProperty.call(e,s)&&0>t.indexOf(s)&&(i[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(r=0,s=Object.getOwnPropertySymbols(e);r<s.length;r++)0>t.indexOf(s[r])&&{}.propertyIsEnumerable.call(e,s[r])&&(i[s[r]]=e[s[r]]);return i};class oe{constructor({url:e="",headers:t={},fetch:s}){this.url=e,this.headers=t,this.fetch=X(s),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}async signOut(t,s=ne[0]){if(0>ne.indexOf(s))throw Error("@supabase/auth-js: Parameter scope must be one of "+ne.join(", "));try{return await g(this.fetch,"POST",`${this.url}/logout?scope=${s}`,{headers:this.headers,jwt:t,noResolveJson:!0}),{data:null,error:null}}catch(r){if(e(r))return{data:null,error:r};throw r}}async inviteUserByEmail(t,s={}){try{return await g(this.fetch,"POST",this.url+"/invite",{body:{email:t,data:s.data},headers:this.headers,redirectTo:s.redirectTo,xform:_})}catch(r){if(e(r))return{data:{user:null},error:r};throw r}}async generateLink(t){try{const{options:e}=t,s=I(t,["options"]),r=Object.assign(Object.assign({},s),e);return"newEmail"in s&&(r.new_email=null==s?void 0:s.newEmail,delete r.newEmail),await g(this.fetch,"POST",this.url+"/admin/generate_link",{body:r,headers:this.headers,xform:v,redirectTo:null==e?void 0:e.redirectTo})}catch(s){if(e(s))return{data:{properties:null,user:null},error:s};throw s}}async createUser(t){try{return await g(this.fetch,"POST",this.url+"/admin/users",{body:t,headers:this.headers,xform:_})}catch(s){if(e(s))return{data:{user:null},error:s};throw s}}async listUsers(t){var s,r,i,a,n,o,l;try{const e={nextPage:null,lastPage:0,total:0},u=await g(this.fetch,"GET",this.url+"/admin/users",{headers:this.headers,noResolveJson:!0,query:{page:null!==(r=null===(s=null==t?void 0:t.page)||void 0===s?void 0:s.toString())&&void 0!==r?r:"",per_page:null!==(a=null===(i=null==t?void 0:t.perPage)||void 0===i?void 0:i.toString())&&void 0!==a?a:""},xform:b});if(u.error)throw u.error;const c=await u.json(),h=null!==(n=u.headers.get("x-total-count"))&&void 0!==n?n:0,d=null!==(l=null===(o=u.headers.get("link"))||void 0===o?void 0:o.split(","))&&void 0!==l?l:[];return d.length>0&&(d.forEach(t=>{const s=parseInt(t.split(";")[0].split("=")[1].substring(0,1)),r=JSON.parse(t.split(";")[1].split("=")[1]);e[r+"Page"]=s}),e.total=parseInt(h)),{data:Object.assign(Object.assign({},c),e),error:null}}catch(u){if(e(u))return{data:{users:[]},error:u};throw u}}async getUserById(t){h(t);try{return await g(this.fetch,"GET",`${this.url}/admin/users/${t}`,{headers:this.headers,xform:_})}catch(s){if(e(s))return{data:{user:null},error:s};throw s}}async updateUserById(t,s){h(t);try{return await g(this.fetch,"PUT",`${this.url}/admin/users/${t}`,{body:s,headers:this.headers,xform:_})}catch(r){if(e(r))return{data:{user:null},error:r};throw r}}async deleteUser(t,s=!1){h(t);try{return await g(this.fetch,"DELETE",`${this.url}/admin/users/${t}`,{headers:this.headers,body:{should_soft_delete:s},xform:_})}catch(r){if(e(r))return{data:{user:null},error:r};throw r}}async _listFactors(t){h(t.userId);try{const{data:e,error:s}=await g(this.fetch,"GET",`${this.url}/admin/users/${t.userId}/factors`,{headers:this.headers,xform:e=>({data:{factors:e},error:null})});return{data:e,error:s}}catch(s){if(e(s))return{data:null,error:s};throw s}}async _deleteFactor(t){h(t.userId),h(t.id);try{return{data:await g(this.fetch,"DELETE",`${this.url}/admin/users/${t.userId}/factors/${t.id}`,{headers:this.headers}),error:null}}catch(s){if(e(s))return{data:null,error:s};throw s}}}const le=!!(globalThis&&Y()&&globalThis.localStorage&&"true"===globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug"));class ue extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class ce extends ue{}!function(){if("object"!=typeof globalThis)try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch(e){"undefined"!=typeof self&&(self.globalThis=self)}}();const he={url:"http://localhost:9999",storageKey:"supabase.auth.token",autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:j,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1},de={};class fe{constructor(e){var t,s;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=fe.nextInstanceID,fe.nextInstanceID+=1,this.instanceID>0&&J();const r=Object.assign(Object.assign({},he),e);if(this.logDebugMessages=!!r.debug,"function"==typeof r.debug&&(this.logger=r.debug),this.persistSession=r.persistSession,this.storageKey=r.storageKey,this.autoRefreshToken=r.autoRefreshToken,this.admin=new oe({url:r.url,headers:r.headers,fetch:r.fetch}),this.url=r.url,this.headers=r.headers,this.fetch=X(r.fetch),this.lock=r.lock||S,this.detectSessionInUrl=r.detectSessionInUrl,this.flowType=r.flowType,this.hasCustomAuthorizationHeader=r.hasCustomAuthorizationHeader,r.lock?this.lock=r.lock:J()&&(null===(t=null===globalThis||void 0===globalThis?void 0:globalThis.navigator)||void 0===t?void 0:t.locks)?this.lock=k:this.lock=S,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?(r.storage?this.storage=r.storage:Y()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=m(this.memoryStorage)),r.userStorage&&(this.userStorage=r.userStorage)):(this.memoryStorage={},this.storage=m(this.memoryStorage)),J()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(i){}null===(s=this.broadcastChannel)||void 0===s||s.addEventListener("message",async e=>{this._debug("received broadcast notification from other tab or client",e),await this._notifyAllSubscribers(e.data.event,e.data.session,!1)})}this.initialize()}get jwks(){var e,t;return null!==(t=null===(e=de[this.storageKey])||void 0===e?void 0:e.jwks)&&void 0!==t?t:{keys:[]}}set jwks(e){de[this.storageKey]=Object.assign(Object.assign({},de[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,t;return null!==(t=null===(e=de[this.storageKey])||void 0===e?void 0:e.cachedAt)&&void 0!==t?t:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){de[this.storageKey]=Object.assign(Object.assign({},de[this.storageKey]),{cachedAt:e})}_debug(...e){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${E}) ${(new Date).toISOString()}`,...e),this}async initialize(){return this.initializePromise||(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))()),await this.initializePromise}async _initialize(){var t;try{const s=function(e){const t={},s=new URL(e);if(s.hash&&"#"===s.hash[0])try{new URLSearchParams(s.hash.substring(1)).forEach((e,s)=>{t[s]=e})}catch(r){}return s.searchParams.forEach((e,s)=>{t[s]=e}),t}(window.location.href);let r="none";if(this._isImplicitGrantCallback(s)?r="implicit":await this._isPKCECallback(s)&&(r="pkce"),J()&&this.detectSessionInUrl&&"none"!==r){const{data:i,error:a}=await this._getSessionFromURL(s,r);if(a){if(this._debug("#_initialize()","error detecting session from URL",a),function(t){return e(t)&&"AuthImplicitGrantRedirectError"===t.name}(a)){const e=null===(t=a.details)||void 0===t?void 0:t.code;if("identity_already_exists"===e||"identity_not_found"===e||"single_identity_not_deletable"===e)return{error:a}}return await this._removeSession(),{error:a}}const{session:n,redirectType:o}=i;return this._debug("#_initialize()","detected session in URL",n,"redirect type",o),await this._saveSession(n),setTimeout(async()=>{"recovery"===o?await this._notifyAllSubscribers("PASSWORD_RECOVERY",n):await this._notifyAllSubscribers("SIGNED_IN",n)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(s){return e(s)?{error:s}:{error:new U("Unexpected error during initialization",s)}}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(t){var s,r,i;try{const e=await g(this.fetch,"POST",this.url+"/signup",{headers:this.headers,body:{data:null!==(r=null===(s=null==t?void 0:t.options)||void 0===s?void 0:s.data)&&void 0!==r?r:{},gotrue_meta_security:{captcha_token:null===(i=null==t?void 0:t.options)||void 0===i?void 0:i.captchaToken}},xform:w}),{data:a,error:n}=e;if(n||!a)return{data:{user:null,session:null},error:n};const o=a.session,l=a.user;return a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",o)),{data:{user:l,session:o},error:null}}catch(a){if(e(a))return{data:{user:null,session:null},error:a};throw a}}async signUp(t){var s,r,i;try{let e;if("email"in t){const{email:r,password:i,options:a}=t;let n=null,o=null;"pkce"===this.flowType&&([n,o]=await c(this.storage,this.storageKey)),e=await g(this.fetch,"POST",this.url+"/signup",{headers:this.headers,redirectTo:null==a?void 0:a.emailRedirectTo,body:{email:r,password:i,data:null!==(s=null==a?void 0:a.data)&&void 0!==s?s:{},gotrue_meta_security:{captcha_token:null==a?void 0:a.captchaToken},code_challenge:n,code_challenge_method:o},xform:w})}else{if(!("phone"in t))throw new K("You must provide either an email or phone number and a password");{const{phone:s,password:a,options:n}=t;e=await g(this.fetch,"POST",this.url+"/signup",{headers:this.headers,body:{phone:s,password:a,data:null!==(r=null==n?void 0:n.data)&&void 0!==r?r:{},channel:null!==(i=null==n?void 0:n.channel)&&void 0!==i?i:"sms",gotrue_meta_security:{captcha_token:null==n?void 0:n.captchaToken}},xform:w})}}const{data:a,error:n}=e;if(n||!a)return{data:{user:null,session:null},error:n};const o=a.session,l=a.user;return a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",o)),{data:{user:l,session:o},error:null}}catch(a){if(e(a))return{data:{user:null,session:null},error:a};throw a}}async signInWithPassword(t){try{let e;if("email"in t){const{email:s,password:r,options:i}=t;e=await g(this.fetch,"POST",this.url+"/token?grant_type=password",{headers:this.headers,body:{email:s,password:r,gotrue_meta_security:{captcha_token:null==i?void 0:i.captchaToken}},xform:y})}else{if(!("phone"in t))throw new K("You must provide either an email or phone number and a password");{const{phone:s,password:r,options:i}=t;e=await g(this.fetch,"POST",this.url+"/token?grant_type=password",{headers:this.headers,body:{phone:s,password:r,gotrue_meta_security:{captcha_token:null==i?void 0:i.captchaToken}},xform:y})}}const{data:s,error:r}=e;return r?{data:{user:null,session:null},error:r}:s&&s.session&&s.user?(s.session&&(await this._saveSession(s.session),await this._notifyAllSubscribers("SIGNED_IN",s.session)),{data:Object.assign({user:s.user,session:s.session},s.weak_password?{weakPassword:s.weak_password}:null),error:r}):{data:{user:null,session:null},error:new N}}catch(s){if(e(s))return{data:{user:null,session:null},error:s};throw s}}async signInWithOAuth(e){var t,s,r,i;return await this._handleProviderSignIn(e.provider,{redirectTo:null===(t=e.options)||void 0===t?void 0:t.redirectTo,scopes:null===(s=e.options)||void 0===s?void 0:s.scopes,queryParams:null===(r=e.options)||void 0===r?void 0:r.queryParams,skipBrowserRedirect:null===(i=e.options)||void 0===i?void 0:i.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:t}=e;if("solana"===t)return await this.signInWithSolana(e);throw Error(`@supabase/auth-js: Unsupported chain "${t}"`)}async signInWithSolana(t){var s,r,i,a,n,l,u,c,h,d,f,y;let _,p;if("message"in t)_=t.message,p=t.signature;else{const{chain:e,wallet:o,statement:f,options:g}=t;let w;if(J())if("object"==typeof o)w=o;else{const e=window;if(!("solana"in e)||"object"!=typeof e.solana||!("signIn"in e.solana&&"function"==typeof e.solana.signIn||"signMessage"in e.solana&&"function"==typeof e.solana.signMessage))throw Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.");w=e.solana}else{if("object"!=typeof o||!(null==g?void 0:g.url))throw Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");w=o}const y=new URL(null!==(s=null==g?void 0:g.url)&&void 0!==s?s:window.location.href);if("signIn"in w&&w.signIn){const e=await w.signIn(Object.assign(Object.assign(Object.assign({issuedAt:(new Date).toISOString()},null==g?void 0:g.signInWithSolana),{version:"1",domain:y.host,uri:y.href}),f?{statement:f}:null));let t;if(Array.isArray(e)&&e[0]&&"object"==typeof e[0])t=e[0];else{if(!(e&&"object"==typeof e&&"signedMessage"in e&&"signature"in e))throw Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");t=e}if(!("signedMessage"in t&&"signature"in t&&("string"==typeof t.signedMessage||t.signedMessage instanceof Uint8Array)&&t.signature instanceof Uint8Array))throw Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields");_="string"==typeof t.signedMessage?t.signedMessage:(new TextDecoder).decode(t.signedMessage),p=t.signature}else{if(!("signMessage"in w&&"function"==typeof w.signMessage&&"publicKey"in w&&"object"==typeof w&&w.publicKey&&"toBase58"in w.publicKey&&"function"==typeof w.publicKey.toBase58))throw Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");_=[y.host+" wants you to sign in with your Solana account:",w.publicKey.toBase58(),...f?["",f,""]:[""],"Version: 1","URI: "+y.href,"Issued At: "+(null!==(i=null===(r=null==g?void 0:g.signInWithSolana)||void 0===r?void 0:r.issuedAt)&&void 0!==i?i:(new Date).toISOString()),...(null===(a=null==g?void 0:g.signInWithSolana)||void 0===a?void 0:a.notBefore)?["Not Before: "+g.signInWithSolana.notBefore]:[],...(null===(n=null==g?void 0:g.signInWithSolana)||void 0===n?void 0:n.expirationTime)?["Expiration Time: "+g.signInWithSolana.expirationTime]:[],...(null===(l=null==g?void 0:g.signInWithSolana)||void 0===l?void 0:l.chainId)?["Chain ID: "+g.signInWithSolana.chainId]:[],...(null===(u=null==g?void 0:g.signInWithSolana)||void 0===u?void 0:u.nonce)?["Nonce: "+g.signInWithSolana.nonce]:[],...(null===(c=null==g?void 0:g.signInWithSolana)||void 0===c?void 0:c.requestId)?["Request ID: "+g.signInWithSolana.requestId]:[],...(null===(d=null===(h=null==g?void 0:g.signInWithSolana)||void 0===h?void 0:h.resources)||void 0===d?void 0:d.length)?["Resources",...g.signInWithSolana.resources.map(e=>"- "+e)]:[]].join("\n");const e=await w.signMessage((new TextEncoder).encode(_),"utf8");if(!(e&&e instanceof Uint8Array))throw Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");p=e}}try{const{data:e,error:s}=await g(this.fetch,"POST",this.url+"/token?grant_type=web3",{headers:this.headers,body:Object.assign({chain:"solana",message:_,signature:o(p)},(null===(f=t.options)||void 0===f?void 0:f.captchaToken)?{gotrue_meta_security:{captcha_token:null===(y=t.options)||void 0===y?void 0:y.captchaToken}}:null),xform:w});if(s)throw s;return e&&e.session&&e.user?(e.session&&(await this._saveSession(e.session),await this._notifyAllSubscribers("SIGNED_IN",e.session)),{data:Object.assign({},e),error:s}):{data:{user:null,session:null},error:new N}}catch(v){if(e(v))return{data:{user:null,session:null},error:v};throw v}}async _exchangeCodeForSession(t){const s=await Q(this.storage,this.storageKey+"-code-verifier"),[r,i]=(null!=s?s:"").split("/");try{const{data:e,error:s}=await g(this.fetch,"POST",this.url+"/token?grant_type=pkce",{headers:this.headers,body:{auth_code:t,code_verifier:r},xform:w});if(await ee(this.storage,this.storageKey+"-code-verifier"),s)throw s;return e&&e.session&&e.user?(e.session&&(await this._saveSession(e.session),await this._notifyAllSubscribers("SIGNED_IN",e.session)),{data:Object.assign(Object.assign({},e),{redirectType:null!=i?i:null}),error:s}):{data:{user:null,session:null,redirectType:null},error:new N}}catch(a){if(e(a))return{data:{user:null,session:null,redirectType:null},error:a};throw a}}async signInWithIdToken(t){try{const{options:e,provider:s,token:r,access_token:i,nonce:a}=t,n=await g(this.fetch,"POST",this.url+"/token?grant_type=id_token",{headers:this.headers,body:{provider:s,id_token:r,access_token:i,nonce:a,gotrue_meta_security:{captcha_token:null==e?void 0:e.captchaToken}},xform:w}),{data:o,error:l}=n;return l?{data:{user:null,session:null},error:l}:o&&o.session&&o.user?(o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",o.session)),{data:o,error:l}):{data:{user:null,session:null},error:new N}}catch(s){if(e(s))return{data:{user:null,session:null},error:s};throw s}}async signInWithOtp(t){var s,r,i,a,n;try{if("email"in t){const{email:e,options:i}=t;let a=null,n=null;"pkce"===this.flowType&&([a,n]=await c(this.storage,this.storageKey));const{error:o}=await g(this.fetch,"POST",this.url+"/otp",{headers:this.headers,body:{email:e,data:null!==(s=null==i?void 0:i.data)&&void 0!==s?s:{},create_user:null===(r=null==i?void 0:i.shouldCreateUser)||void 0===r||r,gotrue_meta_security:{captcha_token:null==i?void 0:i.captchaToken},code_challenge:a,code_challenge_method:n},redirectTo:null==i?void 0:i.emailRedirectTo});return{data:{user:null,session:null},error:o}}if("phone"in t){const{phone:e,options:s}=t,{data:r,error:o}=await g(this.fetch,"POST",this.url+"/otp",{headers:this.headers,body:{phone:e,data:null!==(i=null==s?void 0:s.data)&&void 0!==i?i:{},create_user:null===(a=null==s?void 0:s.shouldCreateUser)||void 0===a||a,gotrue_meta_security:{captcha_token:null==s?void 0:s.captchaToken},channel:null!==(n=null==s?void 0:s.channel)&&void 0!==n?n:"sms"}});return{data:{user:null,session:null,messageId:null==r?void 0:r.message_id},error:o}}throw new K("You must provide either an email or phone number.")}catch(o){if(e(o))return{data:{user:null,session:null},error:o};throw o}}async verifyOtp(t){var s,r;try{let e,i;"options"in t&&(e=null===(s=t.options)||void 0===s?void 0:s.redirectTo,i=null===(r=t.options)||void 0===r?void 0:r.captchaToken);const{data:a,error:n}=await g(this.fetch,"POST",this.url+"/verify",{headers:this.headers,body:Object.assign(Object.assign({},t),{gotrue_meta_security:{captcha_token:i}}),redirectTo:e,xform:w});if(n)throw n;if(!a)throw Error("An error occurred on token verification.");const o=a.session,l=a.user;return(null==o?void 0:o.access_token)&&(await this._saveSession(o),await this._notifyAllSubscribers("recovery"==t.type?"PASSWORD_RECOVERY":"SIGNED_IN",o)),{data:{user:l,session:o},error:null}}catch(i){if(e(i))return{data:{user:null,session:null},error:i};throw i}}async signInWithSSO(t){var s,r,i;try{let e=null,a=null;return"pkce"===this.flowType&&([e,a]=await c(this.storage,this.storageKey)),await g(this.fetch,"POST",this.url+"/sso",{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in t?{provider_id:t.providerId}:null),"domain"in t?{domain:t.domain}:null),{redirect_to:null!==(r=null===(s=t.options)||void 0===s?void 0:s.redirectTo)&&void 0!==r?r:void 0}),(null===(i=null==t?void 0:t.options)||void 0===i?void 0:i.captchaToken)?{gotrue_meta_security:{captcha_token:t.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:e,code_challenge_method:a}),headers:this.headers,xform:p})}catch(a){if(e(a))return{data:null,error:a};throw a}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:s}=e;if(s)throw s;if(!t)throw new D;const{error:r}=await g(this.fetch,"GET",this.url+"/reauthenticate",{headers:this.headers,jwt:t.access_token});return{data:{user:null,session:null},error:r}})}catch(t){if(e(t))return{data:{user:null,session:null},error:t};throw t}}async resend(t){try{const e=this.url+"/resend";if("email"in t){const{email:s,type:r,options:i}=t,{error:a}=await g(this.fetch,"POST",e,{headers:this.headers,body:{email:s,type:r,gotrue_meta_security:{captcha_token:null==i?void 0:i.captchaToken}},redirectTo:null==i?void 0:i.emailRedirectTo});return{data:{user:null,session:null},error:a}}if("phone"in t){const{phone:s,type:r,options:i}=t,{data:a,error:n}=await g(this.fetch,"POST",e,{headers:this.headers,body:{phone:s,type:r,gotrue_meta_security:{captcha_token:null==i?void 0:i.captchaToken}}});return{data:{user:null,session:null,messageId:null==a?void 0:a.message_id},error:n}}throw new K("You must provide either an email or phone number and a type")}catch(s){if(e(s))return{data:{user:null,session:null},error:s};throw s}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async e=>e))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const e=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),s=(async()=>(await e,await t()))();return this.pendingInLock.push((async()=>{try{await s}catch(e){}})()),s}return await this.lock("lock:"+this.storageKey,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const e=t();for(this.pendingInLock.push((async()=>{try{await e}catch(t){}})()),await e;this.pendingInLock.length;){const e=[...this.pendingInLock];await Promise.all(e),this.pendingInLock.splice(0,e.length)}return await e}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",Error().stack);try{let e=null;const t=await Q(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),null!==t&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const s=!!e.expires_at&&9e4>1e3*e.expires_at-Date.now();if(this._debug("#__loadSession()",`session has${s?"":" not"} expired`,"expires_at",e.expires_at),!s){if(this.userStorage){const t=await Q(this.userStorage,this.storageKey+"-user");(null==t?void 0:t.user)?e.user=t.user:e.user=d()}if(this.storage.isServer&&e.user){let t=this.suppressGetSessionWarning;e=new Proxy(e,{get:(e,s,r)=>(t||"user"!==s||(t=!0,this.suppressGetSessionWarning=!0),Reflect.get(e,s,r))})}return{data:{session:e},error:null}}const{session:r,error:i}=await this._callRefreshToken(e.refresh_token);return i?{data:{session:null},error:i}:{data:{session:r},error:null}}finally{this._debug("#__loadSession()","end")}}async getUser(e){return e?await this._getUser(e):(await this.initializePromise,await this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(t){try{return t?await g(this.fetch,"GET",this.url+"/user",{headers:this.headers,jwt:t,xform:_}):await this._useSession(async e=>{var t,s,r;const{data:i,error:a}=e;if(a)throw a;return(null===(t=i.session)||void 0===t?void 0:t.access_token)||this.hasCustomAuthorizationHeader?await g(this.fetch,"GET",this.url+"/user",{headers:this.headers,jwt:null!==(r=null===(s=i.session)||void 0===s?void 0:s.access_token)&&void 0!==r?r:void 0,xform:_}):{data:{user:null},error:new D}})}catch(s){if(e(s))return function(t){return e(t)&&"AuthSessionMissingError"===t.name}(s)&&(await this._removeSession(),await ee(this.storage,this.storageKey+"-code-verifier")),{data:{user:null},error:s};throw s}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,t))}async _updateUser(t,s={}){try{return await this._useSession(async e=>{const{data:r,error:i}=e;if(i)throw i;if(!r.session)throw new D;const a=r.session;let n=null,o=null;"pkce"===this.flowType&&null!=t.email&&([n,o]=await c(this.storage,this.storageKey));const{data:l,error:u}=await g(this.fetch,"PUT",this.url+"/user",{headers:this.headers,redirectTo:null==s?void 0:s.emailRedirectTo,body:Object.assign(Object.assign({},t),{code_challenge:n,code_challenge_method:o}),jwt:a.access_token,xform:_});if(u)throw u;return a.user=l.user,await this._saveSession(a),await this._notifyAllSubscribers("USER_UPDATED",a),{data:{user:a.user},error:null}})}catch(r){if(e(r))return{data:{user:null},error:r};throw r}}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(t){try{if(!t.access_token||!t.refresh_token)throw new D;const e=Date.now()/1e3;let s=e,r=!0,i=null;const{payload:a}=l(t.access_token);if(a.exp&&(s=a.exp,r=e>=s),r){const{session:e,error:s}=await this._callRefreshToken(t.refresh_token);if(s)return{data:{user:null,session:null},error:s};if(!e)return{data:{user:null,session:null},error:null};i=e}else{const{data:r,error:a}=await this._getUser(t.access_token);if(a)throw a;i={access_token:t.access_token,refresh_token:t.refresh_token,user:r.user,token_type:"bearer",expires_in:s-e,expires_at:s},await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)}return{data:{user:i.user,session:i},error:null}}catch(s){if(e(s))return{data:{session:null,user:null},error:s};throw s}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(t){try{return await this._useSession(async e=>{var s;if(!t){const{data:r,error:i}=e;if(i)throw i;t=null!==(s=r.session)&&void 0!==s?s:void 0}if(!(null==t?void 0:t.refresh_token))throw new D;const{session:r,error:i}=await this._callRefreshToken(t.refresh_token);return i?{data:{user:null,session:null},error:i}:r?{data:{user:r.user,session:r},error:null}:{data:{user:null,session:null},error:null}})}catch(s){if(e(s))return{data:{user:null,session:null},error:s};throw s}}async _getSessionFromURL(t,s){try{if(!J())throw new $("No browser detected.");if(t.error||t.error_description||t.error_code)throw new $(t.error_description||"Error in URL with unspecified error_description",{error:t.error||"unspecified_error",code:t.error_code||"unspecified_code"});switch(s){case"implicit":if("pkce"===this.flowType)throw new W("Not a valid PKCE flow url.");break;case"pkce":if("implicit"===this.flowType)throw new $("Not a valid implicit grant flow url.")}if("pkce"===s){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!t.code)throw new W("No code detected.");const{data:e,error:s}=await this._exchangeCodeForSession(t.code);if(s)throw s;const r=new URL(window.location.href);return r.searchParams.delete("code"),window.history.replaceState(window.history.state,"",r.toString()),{data:{session:e.session,redirectType:null},error:null}}const{provider_token:e,provider_refresh_token:r,access_token:i,refresh_token:a,expires_in:n,expires_at:o,token_type:l}=t;if(!(i&&n&&a&&l))throw new $("No session defined in URL");const u=Math.round(Date.now()/1e3),c=parseInt(n);let h=u+c;o&&(h=parseInt(o));const{data:d,error:f}=await this._getUser(i);if(f)throw f;const g={provider_token:e,provider_refresh_token:r,access_token:i,expires_in:c,expires_at:h,refresh_token:a,token_type:l,user:d.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:g,redirectType:t.type},error:null}}catch(r){if(e(r))return{data:{session:null,redirectType:null},error:r};throw r}}_isImplicitGrantCallback(e){return!(!e.access_token&&!e.error_description)}async _isPKCECallback(e){const t=await Q(this.storage,this.storageKey+"-code-verifier");return!(!e.code||!t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:t}={scope:"global"}){return await this._useSession(async s=>{var r;const{data:i,error:a}=s;if(a)return{error:a};const n=null===(r=i.session)||void 0===r?void 0:r.access_token;if(n){const{error:s}=await this.admin.signOut(n,t);if(s&&(!function(t){return e(t)&&"AuthApiError"===t.name}(s)||404!==s.status&&401!==s.status&&403!==s.status))return{error:s}}return"others"!==t&&(await this._removeSession(),await ee(this.storage,this.storageKey+"-code-verifier")),{error:null}})}onAuthStateChange(e){const t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}),s={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,s),(async()=>{await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(t)})})(),{data:{subscription:s}}}async _emitInitialSession(e){return await this._useSession(async t=>{var s,r;try{const{data:{session:r},error:i}=t;if(i)throw i;await(null===(s=this.stateChangeEmitters.get(e))||void 0===s?void 0:s.callback("INITIAL_SESSION",r)),this._debug("INITIAL_SESSION","callback id",e,"session",r)}catch(i){await(null===(r=this.stateChangeEmitters.get(e))||void 0===r?void 0:r.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",i)}})}async resetPasswordForEmail(t,s={}){let r=null,i=null;"pkce"===this.flowType&&([r,i]=await c(this.storage,this.storageKey,!0));try{return await g(this.fetch,"POST",this.url+"/recover",{body:{email:t,code_challenge:r,code_challenge_method:i,gotrue_meta_security:{captcha_token:s.captchaToken}},headers:this.headers,redirectTo:s.redirectTo})}catch(a){if(e(a))return{data:null,error:a};throw a}}async getUserIdentities(){var t;try{const{data:e,error:s}=await this.getUser();if(s)throw s;return{data:{identities:null!==(t=e.user.identities)&&void 0!==t?t:[]},error:null}}catch(s){if(e(s))return{data:null,error:s};throw s}}async linkIdentity(t){var s;try{const{data:e,error:r}=await this._useSession(async e=>{var s,r,i,a,n;const{data:o,error:l}=e;if(l)throw l;const u=await this._getUrlForProvider(this.url+"/user/identities/authorize",t.provider,{redirectTo:null===(s=t.options)||void 0===s?void 0:s.redirectTo,scopes:null===(r=t.options)||void 0===r?void 0:r.scopes,queryParams:null===(i=t.options)||void 0===i?void 0:i.queryParams,skipBrowserRedirect:!0});return await g(this.fetch,"GET",u,{headers:this.headers,jwt:null!==(n=null===(a=o.session)||void 0===a?void 0:a.access_token)&&void 0!==n?n:void 0})});if(r)throw r;return J()&&!(null===(s=t.options)||void 0===s?void 0:s.skipBrowserRedirect)&&window.location.assign(null==e?void 0:e.url),{data:{provider:t.provider,url:null==e?void 0:e.url},error:null}}catch(r){if(e(r))return{data:{provider:t.provider,url:null},error:r};throw r}}async unlinkIdentity(t){try{return await this._useSession(async e=>{var s,r;const{data:i,error:a}=e;if(a)throw a;return await g(this.fetch,"DELETE",`${this.url}/user/identities/${t.identity_id}`,{headers:this.headers,jwt:null!==(r=null===(s=i.session)||void 0===s?void 0:s.access_token)&&void 0!==r?r:void 0})})}catch(s){if(e(s))return{data:null,error:s};throw s}}async _refreshAccessToken(s){const r=`#_refreshAccessToken(${s.substring(0,5)}...)`;this._debug(r,"begin");try{const e=Date.now();return await(i=async e=>(e>0&&await async function(e){return await new Promise(t=>{setTimeout(()=>t(null),e)})}(200*Math.pow(2,e-1)),this._debug(r,"refreshing attempt",e),await g(this.fetch,"POST",this.url+"/token?grant_type=refresh_token",{body:{refresh_token:s},headers:this.headers,xform:w})),a=(s,r)=>{const i=200*Math.pow(2,s);return r&&t(r)&&Date.now()+i-e<x},new Promise((e,t)=>{(async()=>{for(let r=0;1/0>r;r++)try{const t=await i(r);if(!a(r,null))return void e(t)}catch(s){if(!a(r,s))return void t(s)}})()}))}catch(n){if(this._debug(r,"error",n),e(n))return{data:{session:null,user:null},error:n};throw n}finally{this._debug(r,"end")}var i,a}_isValidSession(e){return"object"==typeof e&&null!==e&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const s=await this._getUrlForProvider(this.url+"/authorize",e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",s),J()&&!t.skipBrowserRedirect&&window.location.assign(s),{data:{provider:e,url:s},error:null}}async _recoverAndRefresh(){var e,s;const r="#_recoverAndRefresh()";this._debug(r,"begin");try{const a=await Q(this.storage,this.storageKey);if(a&&this.userStorage){let t=await Q(this.userStorage,this.storageKey+"-user");this.storage.isServer||!Object.is(this.storage,this.userStorage)||t||(t={user:a.user},await Z(this.userStorage,this.storageKey+"-user",t)),a.user=null!==(e=null==t?void 0:t.user)&&void 0!==e?e:d()}else if(a&&!a.user&&!a.user){const e=await Q(this.storage,this.storageKey+"-user");e&&(null==e?void 0:e.user)?(a.user=e.user,await ee(this.storage,this.storageKey+"-user"),await Z(this.storage,this.storageKey,a)):a.user=d()}if(this._debug(r,"session from storage",a),!this._isValidSession(a))return this._debug(r,"session is not valid"),void(null!==a&&await this._removeSession());const n=9e4>1e3*(null!==(s=a.expires_at)&&void 0!==s?s:1/0)-Date.now();if(this._debug(r,`session has${n?"":" not"} expired with margin of 90000s`),n){if(this.autoRefreshToken&&a.refresh_token){const{error:e}=await this._callRefreshToken(a.refresh_token);e&&(t(e)||(this._debug(r,"refresh failed with a non-retryable error, removing the session",e),await this._removeSession()))}}else if(a.user&&!0===a.user.__isUserNotAvailableProxy)try{const{data:e,error:t}=await this._getUser(a.access_token);!t&&(null==e?void 0:e.user)?(a.user=e.user,await this._saveSession(a),await this._notifyAllSubscribers("SIGNED_IN",a)):this._debug(r,"could not get user data, skipping SIGNED_IN notification")}catch(i){this._debug(r,"error getting user data, skipping SIGNED_IN notification",i)}else await this._notifyAllSubscribers("SIGNED_IN",a)}catch(a){return void this._debug(r,"error",a)}finally{this._debug(r,"end")}}async _callRefreshToken(s){var r,i;if(!s)throw new D;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const a=`#_callRefreshToken(${s.substring(0,5)}...)`;this._debug(a,"begin");try{this.refreshingDeferred=new te;const{data:e,error:t}=await this._refreshAccessToken(s);if(t)throw t;if(!e.session)throw new D;await this._saveSession(e.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",e.session);const r={session:e.session,error:null};return this.refreshingDeferred.resolve(r),r}catch(n){if(this._debug(a,"error",n),e(n)){const e={session:null,error:n};return t(n)||await this._removeSession(),null===(r=this.refreshingDeferred)||void 0===r||r.resolve(e),e}throw null===(i=this.refreshingDeferred)||void 0===i||i.reject(n),n}finally{this.refreshingDeferred=null,this._debug(a,"end")}}async _notifyAllSubscribers(e,t,s=!0){const r=`#_notifyAllSubscribers(${e})`;this._debug(r,"begin",t,"broadcast = "+s);try{this.broadcastChannel&&s&&this.broadcastChannel.postMessage({event:e,session:t});const r=[],i=Array.from(this.stateChangeEmitters.values()).map(async s=>{try{await s.callback(e,t)}catch(i){r.push(i)}});if(await Promise.all(i),r.length>0){for(let e=0;e<r.length;e+=1);throw r[0]}}finally{this._debug(r,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0;const t=Object.assign({},e),s=t.user&&!0===t.user.__isUserNotAvailableProxy;if(this.userStorage){!s&&t.user&&await Z(this.userStorage,this.storageKey+"-user",{user:t.user});const e=Object.assign({},t);delete e.user;const r=structuredClone(e);await Z(this.storage,this.storageKey,r)}else{const e=structuredClone(t);await Z(this.storage,this.storageKey,e)}}async _removeSession(){this._debug("#_removeSession()"),await ee(this.storage,this.storageKey),await ee(this.storage,this.storageKey+"-code-verifier"),await ee(this.storage,this.storageKey+"-user"),this.userStorage&&await ee(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&J()&&(null===window||void 0===window?void 0:window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(t){}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),x);this.autoRefreshTicker=e,e&&"object"==typeof e&&"function"==typeof e.unref?e.unref():"undefined"!=typeof Deno&&"function"==typeof Deno.unrefTimer&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const t=Date.now();try{return await this._useSession(async e=>{const{data:{session:s}}=e;if(!s||!s.refresh_token||!s.expires_at)return void this._debug("#_autoRefreshTokenTick()","no session");const r=Math.floor((1e3*s.expires_at-t)/x);this._debug("#_autoRefreshTokenTick()",`access token expires in ${r} ticks, a tick lasts 30000ms, refresh threshold is 3 ticks`),r>3||await this._callRefreshToken(s.refresh_token)})}catch(e){}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(!(e.isAcquireTimeout||e instanceof ue))throw e;this._debug("auto refresh token tick lock not available")}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!J()||!(null===window||void 0===window?void 0:window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),null===window||void 0===window||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),"visible"===document.visibilityState?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{"visible"===document.visibilityState?await this._recoverAndRefresh():this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting")}))):"hidden"===document.visibilityState&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,s){const r=["provider="+encodeURIComponent(t)];if((null==s?void 0:s.redirectTo)&&r.push("redirect_to="+encodeURIComponent(s.redirectTo)),(null==s?void 0:s.scopes)&&r.push("scopes="+encodeURIComponent(s.scopes)),"pkce"===this.flowType){const[e,t]=await c(this.storage,this.storageKey),s=new URLSearchParams({code_challenge:""+encodeURIComponent(e),code_challenge_method:""+encodeURIComponent(t)});r.push(s.toString())}if(null==s?void 0:s.queryParams){const e=new URLSearchParams(s.queryParams);r.push(e.toString())}return(null==s?void 0:s.skipBrowserRedirect)&&r.push("skip_http_redirect="+s.skipBrowserRedirect),`${e}?${r.join("&")}`}async _unenroll(t){try{return await this._useSession(async e=>{var s;const{data:r,error:i}=e;return i?{data:null,error:i}:await g(this.fetch,"DELETE",`${this.url}/factors/${t.factorId}`,{headers:this.headers,jwt:null===(s=null==r?void 0:r.session)||void 0===s?void 0:s.access_token})})}catch(s){if(e(s))return{data:null,error:s};throw s}}async _enroll(t){try{return await this._useSession(async e=>{var s,r;const{data:i,error:a}=e;if(a)return{data:null,error:a};const n=Object.assign({friendly_name:t.friendlyName,factor_type:t.factorType},"phone"===t.factorType?{phone:t.phone}:{issuer:t.issuer}),{data:o,error:l}=await g(this.fetch,"POST",this.url+"/factors",{body:n,headers:this.headers,jwt:null===(s=null==i?void 0:i.session)||void 0===s?void 0:s.access_token});return l?{data:null,error:l}:("totp"===t.factorType&&(null===(r=null==o?void 0:o.totp)||void 0===r?void 0:r.qr_code)&&(o.totp.qr_code="data:image/svg+xml;utf-8,"+o.totp.qr_code),{data:o,error:null})})}catch(s){if(e(s))return{data:null,error:s};throw s}}async _verify(t){return this._acquireLock(-1,async()=>{try{return await this._useSession(async e=>{var s;const{data:r,error:i}=e;if(i)return{data:null,error:i};const{data:a,error:n}=await g(this.fetch,"POST",`${this.url}/factors/${t.factorId}/verify`,{body:{code:t.code,challenge_id:t.challengeId},headers:this.headers,jwt:null===(s=null==r?void 0:r.session)||void 0===s?void 0:s.access_token});return n?{data:null,error:n}:(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+a.expires_in},a)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",a),{data:a,error:n})})}catch(s){if(e(s))return{data:null,error:s};throw s}})}async _challenge(t){return this._acquireLock(-1,async()=>{try{return await this._useSession(async e=>{var s;const{data:r,error:i}=e;return i?{data:null,error:i}:await g(this.fetch,"POST",`${this.url}/factors/${t.factorId}/challenge`,{body:{channel:t.channel},headers:this.headers,jwt:null===(s=null==r?void 0:r.session)||void 0===s?void 0:s.access_token})})}catch(s){if(e(s))return{data:null,error:s};throw s}})}async _challengeAndVerify(e){const{data:t,error:s}=await this._challenge({factorId:e.factorId});return s?{data:null,error:s}:await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){const{data:{user:e},error:t}=await this.getUser();if(t)return{data:null,error:t};const s=(null==e?void 0:e.factors)||[],r=s.filter(e=>"totp"===e.factor_type&&"verified"===e.status),i=s.filter(e=>"phone"===e.factor_type&&"verified"===e.status);return{data:{all:s,totp:r,phone:i},error:null}}async _getAuthenticatorAssuranceLevel(){return this._acquireLock(-1,async()=>await this._useSession(async e=>{var t,s;const{data:{session:r},error:i}=e;if(i)return{data:null,error:i};if(!r)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:a}=l(r.access_token);let n=null;a.aal&&(n=a.aal);let o=n;return(null!==(s=null===(t=r.user.factors)||void 0===t?void 0:t.filter(e=>"verified"===e.status))&&void 0!==s?s:[]).length>0&&(o="aal2"),{data:{currentLevel:n,nextLevel:o,currentAuthenticationMethods:a.amr||[]},error:null}}))}async fetchJwk(e,t={keys:[]}){let s=t.keys.find(t=>t.kid===e);if(s)return s;const r=Date.now();if(s=this.jwks.keys.find(t=>t.kid===e),s&&this.jwks_cached_at+6e5>r)return s;const{data:i,error:a}=await g(this.fetch,"GET",this.url+"/.well-known/jwks.json",{headers:this.headers});if(a)throw a;return i.keys&&0!==i.keys.length?(this.jwks=i,this.jwks_cached_at=r,s=i.keys.find(t=>t.kid===e),s||null):null}async getClaims(t,s={}){try{let e=t;if(!e){const{data:t,error:s}=await this.getSession();if(s||!t.session)return{data:null,error:s};e=t.session.access_token}const{header:r,payload:i,signature:n,raw:{header:o,payload:u}}=l(e);(null==s?void 0:s.allowExpired)||function(e){if(!e)throw Error("Missing exp claim");if(Math.floor(Date.now()/1e3)>=e)throw Error("JWT has expired")}(i.exp);const c=r.alg&&!r.alg.startsWith("HS")&&r.kid&&"crypto"in globalThis&&"subtle"in globalThis.crypto?await this.fetchJwk(r.kid,(null==s?void 0:s.keys)?{keys:s.keys}:null==s?void 0:s.jwks):null;if(!c){const{error:t}=await this.getUser(e);if(t)throw t;return{data:{claims:i,header:r,signature:n},error:null}}const h=function(e){switch(e){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw Error("Invalid alg claim")}}(r.alg),d=await crypto.subtle.importKey("jwk",c,h,!0,["verify"]);if(!(await crypto.subtle.verify(h,d,n,function(e){const t=[];return function(e,t){for(let s=0;s<e.length;s+=1){let r=e.charCodeAt(s);if(r>55295&&56319>=r){const t=1024*(r-55296)&65535;r=65536+(e.charCodeAt(s+1)-56320&65535|t),s+=1}a(r,t)}}(e,e=>t.push(e)),new Uint8Array(t)}(`${o}.${u}`))))throw new z("Invalid JWT signature");return{data:{claims:i,header:r,signature:n},error:null}}catch(r){if(e(r))return{data:null,error:r};throw r}}}fe.nextInstanceID=0;const ge=fe;export{ge as A};
